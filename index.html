<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=1.5, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ระบบบันทึกผลการแข่งขัน - กีฬาสี 2568</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(rgba(240, 242, 245, 0.85), rgba(240, 242, 245, 0.85)), 
                        url('https://nonthaphathr.github.io/uploadimg/keelaseebg.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, .nav-link, .btn, .modal-title { font-family: 'Kanit', sans-serif; }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .spinner-logo { width: 80px; animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: var(--glass-shadow);
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .navbar {
            background: rgba(21, 30, 61, 0.98) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .navbar-brand img { height: 50px; margin-right: 12px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }

        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .bg-live { background: #dc3545; color: white; animation: pulse 1.5s infinite; }
        .bg-wait { background: #6c757d; color: white; }
        .bg-done { background: #198754; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .btn-add-match {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 50%, #ffc107 100%);
            background-size: 200% 200%;
            border: none;
            color: #000 !important;
            font-weight: 700;
            font-size: 0.95rem;
            padding: 8px 18px;
            position: relative;
            overflow: hidden;
            animation: gradient-shift 3s ease infinite, btn-glow 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transition: all 0.3s ease;
        }
        .btn-add-match::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -100%;
            width: 100%;
            height: 200%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
            animation: shimmer 2.5s infinite;
        }
        .btn-add-match:hover, .btn-add-match:active {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(255, 193, 7, 0.7);
            color: #000 !important;
        }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 200%; } }
        @keyframes gradient-shift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        @keyframes btn-glow { 0%, 100% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5); } 50% { box-shadow: 0 4px 25px rgba(255, 193, 7, 0.9); } }

        /* Page Section Control */
        .page-section {
            display: none !important;
            width: 100%;
        }

        .page-section.active {
            display: block !important;
        }

        /* Team Selection Styles */
        .team-select-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .team-select-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .team-select-card.selected {
            border-width: 3px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .team-select-card input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .report-preview-page {
            background: white;
            width: 210mm;
            min-height: auto;
            margin: 10px auto;
            padding: 20mm 25mm;
            color: #000;
            position: relative;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
            line-height: 1.5;
            font-size: 14pt;
        }
        
        .speech-line {
            text-align: justify;
            text-justify: inter-word;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .speech-indent {
            text-indent: 2.5cm;
        }
        
        #qrImage { max-width: 100%; height: auto; border: 10px solid white; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #matchList td, #matchList th {
            white-space: nowrap;
            padding: 8px 10px;
        }
        
        @media (max-width: 768px) {
            .container { padding-left: 10px; padding-right: 10px; }
            .navbar-brand span.fs-5 { font-size: 1rem !important; }
            .navbar-brand img { height: 40px; }
            .glass-card { padding: 12px !important; border-radius: 12px; }
            .display-5 { font-size: 2rem !important; }
            .btn-sm { font-size: 0.75rem; padding: 5px 10px; }
            .table { font-size: 0.85rem; }
        }
        
        .btn { min-height: 38px; touch-action: manipulation; }
        html { scroll-behavior: smooth; }
        input, select, textarea { font-size: 16px !important; }
        
        .credit-footer {
            text-align: center;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 300;
        }
        
        .setting-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        .setting-section h6 {
            color: #1a237e;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        /* --- New CSS for Data Management Buttons (Issue 2 Fix) --- */
        .data-mgmt-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .data-mgmt-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .data-mgmt-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            transition: color 0.2s;
        }
        .data-mgmt-btn strong { display: block; font-size: 1rem; color: #333; }
        .data-mgmt-btn small { color: #888; font-size: 0.8rem; }
        
        /* Specific colors on hover */
        .data-mgmt-btn.export-btn:hover { border-color: #198754; background: #f0fff4; }
        .data-mgmt-btn.export-btn:hover i { color: #198754; }
        
        .data-mgmt-btn.import-btn:hover { border-color: #0d6efd; background: #f0f7ff; }
        .data-mgmt-btn.import-btn:hover i { color: #0d6efd; }
        
        .data-mgmt-btn.reset-btn:hover { border-color: #dc3545; background: #fff0f0; }
        .data-mgmt-btn.reset-btn:hover i { color: #dc3545; }
        /* ------------------------------------------------------- */
        
        .team-config-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            transition: all 0.3s;
        }
        .team-config-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .team-color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        #teamManagementModal {
            z-index: 1060 !important;
        }

        #teamManagementModal .modal-backdrop {
            z-index: 1055 !important;
        }
        
        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .report-preview-page {
                margin: 0;
                padding: 20mm 25mm;
                width: 100%;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" class="spinner-logo" id="loadingLogo">
        <h4 class="text-secondary fw-bold">กำลังโหลดข้อมูล...</h4>
        <small class="text-muted" id="loadingEventName">กีฬาสี 2568</small>
        <button class="btn btn-sm btn-outline-secondary mt-3" onclick="forceHideLoader()">กดตรงนี้หากรอนานเกินไป</button>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" alt="Logo" id="navbarLogo">
                <div class="d-flex flex-column ms-2">
                    <span class="fs-5 fw-bold text-warning" id="navbarEventName">กีฬาสี 2568</span>
                    <small class="text-white-50 d-none d-sm-block" style="font-size: 0.75rem;" id="navbarSchoolName">โรงเรียนกระดุมทองวิทยา</small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto gap-2 py-2 py-lg-0">
                    <li class="nav-item"><button class="btn btn-sm btn-outline-light border-0 w-100" onclick="showQRCode()"><i class="fas fa-qrcode me-1"></i> QR ระบบ</button></li>
                    <li class="nav-item">
                        <a href="register.html" target="_blank" class="btn btn-sm btn-outline-warning border-0 w-100 text-start text-lg-center">
                            <i class="fas fa-user-edit me-1"></i> ระบบลงทะเบียน
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="ceremony-docs.html" target="_blank" class="btn btn-sm btn-outline-primary border-0 w-100 text-start text-lg-center">
                            <i class="fas fa-file-invoice me-1"></i> สร้างเอกสารพิธีการ
                        </a>
                    </li>
                    <li class="nav-item"><button class="btn btn-sm btn-outline-info border-0 w-100" onclick="showManual()"><i class="fas fa-book-reader me-1"></i> คู่มือ</button></li>
                    <li class="nav-item"><button class="btn btn-sm btn-outline-success border-0 w-100" onclick="showSettings()"><i class="fas fa-cog me-1"></i> ตั้งค่าระบบ</button></li>
                    <li class="nav-item"><button class="btn btn-sm btn-light w-100" onclick="showPage('dashboard')"><i class="fas fa-home me-1"></i> หน้าหลัก</button></li>
                    <li class="nav-item"><button class="btn btn-sm btn-add-match w-100" onclick="prepareAddMatch()"><i class="fas fa-plus me-1"></i> เพิ่มรายการ</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div id="page-dashboard" class="page-section active">
            <div class="row g-2 g-md-3 mb-3 mb-md-4" id="teamSummaryCards"></div>

            <div class="glass-card p-2 p-md-3">
                <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
                    <span class="fw-bold d-none d-sm-inline"><i class="fas fa-filter"></i> ตัวกรอง:</span>
                    <select id="filterDate" class="form-select form-select-sm" style="width: auto; min-width: 110px;" onchange="applyFilters()">
                        <option value="all">ทุกวัน</option>
                    </select>

                    <select id="filterSport" class="form-select form-select-sm" style="width: auto; min-width: 100px;" onchange="applyFilters()">
                        <option value="all">ทุกกีฬา</option>
                    </select>
                    
                    <select id="filterScoringMethod" class="form-select form-select-sm" style="width: auto; min-width: 120px;" onchange="applyFilters()">
                        <option value="all">ทุกรูปแบบ</option>
                        <option value="score_set">ลงคะแนน Set</option>
                        <option value="win_set">ชนะ/แพ้ Set</option>
                        <option value="score_once">ลงคะแนนรอบเดียว</option>
                        <option value="win_once">ชนะ/แพ้รอบเดียว</option>
                    </select>
                    
                    <select id="filterWinner" class="form-select form-select-sm" style="width: auto; min-width: 90px;" onchange="applyFilters()">
                        <option value="all">ทั้งหมด</option>
                    </select>
                    
                    <div class="ms-auto d-flex gap-2 flex-wrap">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-clipboard-list me-1"></i> คัดลอกข้อมูล
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="previewCopy('schedule')"><i class="far fa-calendar-alt me-2"></i>กำหนดการแข่งขัน</a></li>
                                <li><a class="dropdown-item" href="#" onclick="previewCopy('result')"><i class="fas fa-trophy me-2"></i>ผลการแข่งขัน</a></li>
                            </ul>
                        </div>

                        <button class="btn btn-sm btn-primary" onclick="prepareSchedulePDF()"><i class="fas fa-calendar-alt me-1"></i><span class="d-none d-sm-inline">กำหนดการ(PDF)</span></button>
                        <button class="btn btn-sm btn-danger" onclick="previewSummaryReport()"><i class="fas fa-file-pdf me-1"></i><span class="d-none d-sm-inline">สรุปผล(PDF)</span></button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="min-width: 500px;">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">เวลา</th>
                                <th style="width: 30%;">รายการ</th>
                                <th class="text-center" style="width: 15%;">คะแนน</th>
                                <th class="text-center" style="width: 15%;">ผู้ชนะ</th>
                                <th class="text-end" style="width: 25%;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="matchList" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="page-setup" class="page-section">
            <div class="glass-card p-3 p-md-4 mx-auto" style="max-width: 900px;">
                <h4 class="mb-3 border-bottom pb-2" id="setupTitle"><i class="fas fa-calendar-plus"></i> เพิ่มรายการแข่งขัน</h4>
                <form id="setupForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ชนิดกีฬา</label>
                            <select class="form-select" id="sportType" required>
                                <option value="" disabled selected>-- เลือก --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">รุ่น/ประเภท</label>
                            <input type="text" class="form-control" id="category" placeholder="เช่น ม.ต้น ชาย, ทีมผสม" required>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label small fw-bold">
                                <i class="fas fa-users me-1"></i> เลือกทีมที่เข้าแข่งขัน 
                                <span class="badge bg-info ms-1">อย่างน้อย 2 ทีม</span>
                            </label>
                            <div id="teamSelectionContainer" class="row g-2">
                                </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle"></i> สามารถเลือกได้มากกว่า 2 ทีมสำหรับการแข่งขันหลายรอบ
                            </small>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label small fw-bold">วิธีตัดสิน</label>
                            <select class="form-select" id="scoringMethod" required onchange="toggleSetCount()">
                                <option value="" disabled selected>-- เลือกวิธีตัดสิน --</option>
                                <option value="score_set">ลงคะแนนเป็น Set</option>
                                <option value="win_set">เลือกชนะ/แพ้เป็น Set</option>
                                <option value="score_once">ลงคะแนนรอบเดียว</option>
                                <option value="win_once">เลือกชนะ/แพ้รอบเดียว</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="setCountContainer">
                            <label class="form-label small fw-bold">จำนวน Set</label>
                            <select class="form-select" id="setCount">
                                <option value="3">3 Set (Best of 3)</option>
                                <option value="5">5 Set (Best of 5)</option>
                                <option value="7">7 Set (Best of 7)</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">วันที่</label>
                            <input type="date" class="form-control" id="matchDate" required value="2025-12-03">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">เวลา</label>
                            <input type="time" class="form-control" id="matchTime" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small fw-bold">สถานที่</label>
                            <input type="text" class="form-control" id="location" placeholder="เช่น สนาม 1">
                        </div>
                        <div class="col-12 mt-4">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-light" onclick="showPage('dashboard')">ยกเลิก</button>
                                <button type="submit" class="btn btn-primary px-4" id="setupSubmitBtn">บันทึก</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div id="page-match" class="page-section">
            <button class="btn btn-sm btn-light mb-3 border shadow-sm" onclick="showPage('dashboard')">
                <i class="fas fa-arrow-left"></i> กลับ
            </button>
            
            <div class="row g-3">
                <div class="col-lg-5">
                    <div class="glass-card p-3 h-100">
                        <ul class="nav nav-tabs mb-3" id="matchTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tab-info">ข้อมูล</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tab-players">รายชื่อ</a>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-info">
                                <div id="refereeSection">
                                    <label class="small fw-bold text-muted">กรรมการผู้ตัดสิน</label>
                                    <div id="refereeInputs"></div> 
                                </div>
                                <div class="mt-3">
                                    <label class="small fw-bold text-muted" id="signerLabel">ตัวแทนนักกีฬาผู้ชนะ</label>
                                    <input type="text" class="form-control form-control-sm" id="athleteSign" placeholder="ลงชื่อ...">
                                </div>
                                <div class="mt-3">
                                    <label class="small fw-bold text-muted">หมายเหตุ</label>
                                    <textarea id="matchNote" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                                <button class="btn btn-primary w-100 mt-3" onclick="saveMatchInfo()">
                                    <i class="fas fa-save me-1"></i> บันทึกข้อมูล
                                </button>
                            </div>

                            <div class="tab-pane fade" id="tab-players">
                                <div id="playersTabContent">
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-users fa-2x mb-2 opacity-50"></i>
                                        <p class="small">กำลังโหลดรายชื่อ...</p>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-dark w-100 mt-3" onclick="previewPlayerList()">
                                    <i class="fas fa-print me-1"></i> พิมพ์รายชื่อ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="glass-card p-3 p-md-4 text-center">
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                            <span class="badge bg-secondary" id="matchCatDisplay">Category</span>
                            <span class="status-badge bg-live">LIVE</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearMatchData()">
                                <i class="fas fa-redo me-1"></i> ล้าง
                            </button>
                        </div>
                        
                        <h3 class="fw-bold mb-3 mb-md-4" id="matchTitleDisplay" 
                            style="font-size: clamp(1.2rem, 4vw, 1.75rem);">Sport Name</h3>

                        <div id="scoreDisplayArea" class="mb-3 mb-md-4">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-trophy fa-2x mb-2 opacity-50"></i>
                                <p class="small">กำลังโหลดคะแนน...</p>
                            </div>
                        </div>

                        <div id="dynamicScoreControls" class="bg-white rounded p-3 shadow-sm border text-start">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-lock fa-2x mb-2 opacity-50"></i>
                                <p class="small">กำลังโหลดระบบลงคะแนน...</p>
                            </div>
                        </div>

                        <button class="btn btn-success w-100 mt-3 mt-md-4 py-2 fs-5 shadow-sm" onclick="finishMatch()">
                            <i class="fas fa-check-circle me-2"></i> จบการแข่งขัน
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="credit-footer">
            พัฒนาระบบโดย ครูนนทพัทธ์ หิรัญเรือง
        </div>

    </div>
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">QR Code เข้าระบบ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="copyPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="previewTitle">ตัวอย่างข้อความ</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <textarea id="copyPreviewText" class="form-control border-0 p-3" rows="12" style="font-size: 0.9rem; background: #fafafa;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary" onclick="copyFromPreview()"><i class="fas fa-copy me-1"></i> คัดลอกข้อความ</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>รายงานผล</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="reportContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('reportContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="summaryModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-trophy me-2"></i>สรุปผลการแข่งขัน</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="summaryContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('summaryContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="schedulePDFModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>สร้างกำหนดการแข่งขัน (PDF)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">เลือกวันที่แสดง</label>
                            <select class="form-select" id="scheduleDateSelect">
                                <option value="all">ทุกวัน (รวมทั้งหมด)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">เลือกชนิดกีฬา</label>
                            <select class="form-select" id="scheduleSportSelect">
                                <option value="all">ทุกกีฬา</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">แสดงสถานะ</label>
                            <select class="form-select" id="scheduleStatusSelect">
                                <option value="all">ทั้งหมด</option>
                                <option value="wait">เฉพาะรอแข่ง</option>
                                <option value="done">เฉพาะจบแล้ว</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">รูปแบบเอกสาร</label>
                            <select class="form-select" id="scheduleFormatSelect">
                                <option value="table">ตาราง</option>
                                <option value="list">รายการ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small mt-3 mb-0">
                        <i class="fas fa-info-circle me-1"></i> เลือกตัวกรองแล้วกด "สร้างเอกสาร" เพื่อดูตัวอย่างและพิมพ์
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary" onclick="generateSchedulePDF()"><i class="fas fa-file-pdf me-1"></i> สร้างเอกสาร</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="schedulePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>กำหนดการแข่งขัน</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="scheduleContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('scheduleContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="playerListModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i>ใบรายชื่อนักกีฬา</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="playerListContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('playerListContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>ตั้งค่าระบบ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="setting-section">
                        <h6><i class="fas fa-database me-2"></i>จัดการข้อมูล</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="data-mgmt-btn export-btn" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel d-block"></i>
                                    <strong>ส่งออก Excel</strong>
                                    <small class="d-block mt-1">บันทึกข้อมูลทั้งหมด</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="data-mgmt-btn import-btn" onclick="triggerImportExcel()">
                                    <i class="fas fa-file-import d-block"></i>
                                    <strong>นำเข้า Excel</strong>
                                    <small class="d-block mt-1">โหลดข้อมูลจากไฟล์</small>
                                </div>
                                <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none;" onchange="importFromExcel(event)">
                            </div>
                            <div class="col-md-4">
                                <div class="data-mgmt-btn reset-btn" onclick="resetAllData()">
                                    <i class="fas fa-trash-alt d-block"></i>
                                    <strong>ล้างข้อมูล</strong>
                                    <small class="d-block mt-1">Reset สำหรับปีใหม่</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning small mt-3 mb-0">
                            <i class="fas fa-exclamation-triangle me-1"></i> <strong>คำเตือน:</strong> การล้างข้อมูลจะลบรายการแข่งขันทั้งหมด แต่จะเก็บการตั้งค่าระบบไว้
                        </div>
                    </div>
                    
                    <div class="setting-section">
                        <h6><i class="fas fa-school me-2"></i>ข้อมูลพื้นฐาน</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ชื่อโรงเรียน</label>
                                <input type="text" class="form-control" id="settingSchoolName" placeholder="เช่น โรงเรียนกระดุมทองวิทยา">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ปีการศึกษา</label>
                                <input type="text" class="form-control" id="settingAcademicYear" placeholder="เช่น 2568">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">ชื่อกิจกรรม/งาน</label>
                                <input type="text" class="form-control" id="settingEventName" placeholder="เช่น กีฬาสี">
                            </div>
                        </div>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-users me-2"></i>จัดการทีม</h6>
                        <div id="teamManagementContainer">
                            </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="addNewTeam()">
                            <i class="fas fa-plus me-1"></i> เพิ่มทีมใหม่
                        </button>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-image me-2"></i>รูปภาพ/โลโก้</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ตราโรงเรียน (.png)</label>
                                <input type="file" class="form-control form-control-sm" id="settingSchoolLogo" accept="image/png" onchange="previewLogo('school')">
                                <div class="mt-2 text-center">
                                    <img id="previewSchoolLogo" src="https://nonthaphathr.github.io/uploadimg/logoschool.png" class="logo-preview">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ตรากิจกรรม (.png)</label>
                                <input type="file" class="form-control form-control-sm" id="settingEventLogo" accept="image/png" onchange="previewLogo('event')">
                                <div class="mt-2 text-center">
                                    <img id="previewEventLogo" src="" class="logo-preview" style="display:none;">
                                    <small id="noEventLogoText" class="text-muted">ยังไม่มีรูป</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning small mt-3 mb-0">
                            <i class="fas fa-info-circle"></i> <strong>หมายเหตุ:</strong> รูปภาพจะถูกแปลงเป็น Base64 และบันทึกลง Firebase
                        </div>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-running me-2"></i>รายการกีฬาที่จะจัด</h6>
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="newSportKey" placeholder="รหัส (ภาษาอังกฤษ) เช่น football">
                                <input type="text" class="form-control" id="newSportName" placeholder="ชื่อกีฬา เช่น ฟุตบอล 7 คน">
                                <button class="btn btn-success" type="button" onclick="addSportToList()"><i class="fas fa-plus"></i></button>
                            </div>
                            <small class="text-muted">รหัสกีฬา: ใช้ภาษาอังกฤษ ไม่มีเว้นวรรค</small>
                        </div>
                        <div id="sportListContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-center text-muted small mb-0">กำลังโหลดรายการกีฬา...</p>
                        </div>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-lock me-2"></i>รหัสผ่านระบบ</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">รหัสผ่านกรรมการ (ปลดล็อก/ลบ)</label>
                                <input type="text" class="form-control" id="settingPassword" placeholder="รหัสผ่าน">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-success" onclick="saveSettings()"><i class="fas fa-save me-1"></i> บันทึกการตั้งค่า</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="teamManagementModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>แก้ไขข้อมูลทีม</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTeamKey">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ชื่อทีม</label>
                        <input type="text" class="form-control" id="editTeamName" placeholder="เช่น สีแดง, คณะเหนือ">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">สีประจำทีม</label>
                        <input type="color" class="form-control form-control-color" id="editTeamColor" value="#ffc107">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editTeamActive" checked>
                        <label class="form-check-label" for="editTeamActive">เปิดใช้งานทีมนี้</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveTeamEdit()">
                        <i class="fas fa-save me-1"></i> บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, set, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBc8zSVlgKarSt42YGFgSxHmqG7Max-3U0",
        authDomain: "keelaseesystem.firebaseapp.com",
        databaseURL: "https://keelaseesystem-default-rtdb.firebaseio.com",
        projectId: "keelaseesystem",
        storageBucket: "keelaseesystem.firebasestorage.app",
        messagingSenderId: "434885983982",
        appId: "1:434885983982:web:ffb751f1652abf2308fdff"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    let currentMatchId = null;
    let matchDataLocal = {}; // ตัวแปรสำคัญสำหรับเก็บค่าล่าสุดในเครื่อง
    let allMatchesData = {};
    let allMatchesArray = [];
    let editingMatchId = null;
    let isMatchUnlocked = false;

    // ===== ข้อมูลการตั้งค่าระบบ (รองรับ Dynamic Teams) =====
    let systemSettings = {
        schoolName: 'โรงเรียนกระดุมทองวิทยา',
        eventName: 'กีฬาสี',
        academicYear: '2568',
        schoolLogo: 'https://nonthaphathr.github.io/uploadimg/logoschool.png',
        eventLogo: '',
        password: 'KTW1234',
        teams: {
            'team1': { name: 'สีเหลือง', color: '#ffc107', active: true },
            'team2': { name: 'สีฟ้า', color: '#2196f3', active: true }
        },
        sports: {
            'football': 'ฟุตบอล 7 คน',
            'volleyball': 'วอลเลย์บอล',
            'beach_volleyball': 'วอลเลย์บอลชายหาด',
            'sepaktakraw': 'เซปักตะกร้อ',
            'esports': 'E-Sports ROV',
            'petanque': 'เปตอง',
            'athletics': 'กรีฑา',
            'folksport': 'กีฬาพื้นบ้าน',
            'cheer': 'ประกวดกองเชียร์ฯ'
        }
    };

    // ===== Helper Functions สำหรับ Teams =====
    window.getActiveTeams = () => {
        return Object.entries(systemSettings.teams || {})
            .filter(([key, team]) => team.active)
            .map(([key, team]) => ({ key, ...team }));
    };

    window.getTeamByKey = (key) => {
        return systemSettings.teams?.[key] || { name: key, color: '#999', active: false };
    };

    // ===== ฟังก์ชันแสดง/ซ่อนหน้า =====
    window.showPage = (pageId) => {
        document.querySelectorAll('.page-section').forEach(el => {
            el.classList.remove('active');
        });
        
        const targetPage = document.getElementById('page-' + pageId);
        if (targetPage) {
            targetPage.classList.add('active');
        }
        
        if (pageId === 'dashboard') {
            renderMatchList();
            editingMatchId = null;
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // ===== โหลดการตั้งค่าจาก Firebase =====
    function loadSettings() {
        onValue(ref(db, 'settings'), (snap) => {
            const data = snap.val();
            if (data) {
                systemSettings = { ...systemSettings, ...data };
                if (data.sports) systemSettings.sports = data.sports;
                if (data.teams) systemSettings.teams = data.teams;
            }
            applySettingsToUI();
            updateSportDropdown();
            updateScheduleDropdowns();
            renderTeamSummaryCards();
            renderTeamManagement();
        }, { onlyOnce: true });
    }

    // ===== ใช้การตั้งค่ากับ UI =====
    function applySettingsToUI() {
        document.getElementById('navbarLogo').src = systemSettings.schoolLogo;
        document.getElementById('navbarEventName').innerText = `${systemSettings.eventName} ${systemSettings.academicYear}`;
        document.getElementById('navbarSchoolName').innerText = systemSettings.schoolName;
        document.getElementById('loadingLogo').src = systemSettings.schoolLogo;
        document.getElementById('loadingEventName').innerText = `${systemSettings.eventName} ${systemSettings.academicYear}`;
        document.title = `ระบบบันทึกผลการแข่งขัน - ${systemSettings.eventName} ${systemSettings.academicYear}`;
        
        const filterWinner = document.getElementById('filterWinner');
        const activeTeams = getActiveTeams();
        filterWinner.innerHTML = '<option value="all">ทั้งหมด</option>';
        activeTeams.forEach(team => {
            filterWinner.innerHTML += `<option value="${team.key}">${team.name}ชนะ</option>`;
        });
    }

    // ===== แสดงการ์ดสรุปคะแนนทีม (Dynamic) =====
    function renderTeamSummaryCards() {
        const container = document.getElementById('teamSummaryCards');
        const activeTeams = getActiveTeams();
        
        if (activeTeams.length === 0) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-warning">กรุณาตั้งค่าทีมในระบบก่อนใช้งาน</div></div>';
            return;
        }
        
        container.innerHTML = '';
        activeTeams.forEach(team => {
            let wins = 0;
            allMatchesArray.forEach(m => {
                if (m.status === 'done' && m.winner === team.key) wins++;
            });
            
            // ปรับขนาด Column ตามจำนวนทีม
            let colClass = "col-6 col-md-4";
            if(activeTeams.length <= 2) colClass = "col-6";
            else if(activeTeams.length === 3) colClass = "col-4";
            else if(activeTeams.length === 4) colClass = "col-6 col-md-3";
            
            container.innerHTML += `
                <div class="${colClass}">
                    <div class="glass-card p-2 p-md-3 d-flex justify-content-between align-items-center border-2" 
                         style="border-left: 5px solid ${team.color};">
                        <div>
                            <h4 class="mb-0 fw-bold text-dark" style="font-size: clamp(0.9rem, 3vw, 1.5rem);">
                                <i class="fas fa-medal me-1 me-md-2" style="color: ${team.color};"></i>
                                <span>${team.name}</span>
                            </h4>
                        </div>
                        <div class="text-end">
                            <span class="display-5 fw-bold" id="sumWin_${team.key}">${wins}</span> 
                            <small class="d-none d-sm-inline">เหรียญทอง</small>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // ===== อัพเดท Dropdown กีฬา =====
    function updateSportDropdown() {
        const select = document.getElementById('sportType');
        select.innerHTML = '<option value="" disabled selected>-- เลือก --</option>';
        Object.entries(systemSettings.sports).forEach(([key, name]) => {
            select.innerHTML += `<option value="${key}">${name}</option>`;
        });
    }

    // ===== อัพเดท Dropdown สำหรับกำหนดการ PDF =====
    function updateScheduleDropdowns() {
        const sportSelect = document.getElementById('scheduleSportSelect');
        if (sportSelect) {
            sportSelect.innerHTML = '<option value="all">ทุกกีฬา</option>';
            Object.entries(systemSettings.sports).forEach(([key, name]) => {
                sportSelect.innerHTML += `<option value="${key}">${name}</option>`;
            });
        }
        
        const dateSelect = document.getElementById('scheduleDateSelect');
        if (dateSelect && allMatchesArray.length > 0) {
            dateSelect.innerHTML = '<option value="all">ทุกวัน (รวมทั้งหมด)</option>';
            const dates = [...new Set(allMatchesArray.map(m => m.date))].sort();
            dates.forEach(d => {
                dateSelect.innerHTML += `<option value="${d}">${formatDateThai(d)}</option>`;
            });
        }
    }

    // ===== Render Team Selection (สำหรับหน้า Setup) =====
    function renderTeamSelection() {
        const container = document.getElementById('teamSelectionContainer');
        const activeTeams = getActiveTeams();
        
        if (activeTeams.length < 2) {
            container.innerHTML = '<div class="col-12"><div class="alert alert-danger small">ต้องมีอย่างน้อย 2 ทีมที่เปิดใช้งาน กรุณาตั้งค่าในเมนู "ตั้งค่าระบบ"</div></div>';
            return;
        }
        
        container.innerHTML = '';
        activeTeams.forEach(team => {
            container.innerHTML += `
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="team-select-card">
                        <input class="form-check-input team-checkbox" type="checkbox" 
                               value="${team.key}" id="team_${team.key}" checked>
                        <label class="form-check-label w-100" for="team_${team.key}">
                            <div class="team-color-box" style="width: 100%; height: 5px; background: ${team.color}; margin-bottom: 5px; border-radius: 2px;"></div>
                            <div class="team-name fw-bold">${team.name}</div>
                        </label>
                    </div>
                </div>
            `;
        });
    }

    // ===== แสดง Modal ตั้งค่า =====
    window.showSettings = async () => {
        const { value: pass } = await Swal.fire({
            title: 'ใส่รหัสผ่านเพื่อตั้งค่าระบบ',
            input: 'password',
            inputPlaceholder: 'รหัสผ่าน...',
            showCancelButton: true,
            confirmButtonText: 'เข้าสู่ระบบ',
            cancelButtonText: 'ยกเลิก'
        });
        
        if (pass === systemSettings.password) {
            document.getElementById('settingSchoolName').value = systemSettings.schoolName;
            document.getElementById('settingEventName').value = systemSettings.eventName;
            document.getElementById('settingAcademicYear').value = systemSettings.academicYear;
            document.getElementById('settingPassword').value = systemSettings.password;
            document.getElementById('previewSchoolLogo').src = systemSettings.schoolLogo;
            
            if (systemSettings.eventLogo) {
                document.getElementById('previewEventLogo').src = systemSettings.eventLogo;
                document.getElementById('previewEventLogo').style.display = 'block';
                document.getElementById('noEventLogoText').style.display = 'none';
            } else {
                document.getElementById('previewEventLogo').style.display = 'none';
                document.getElementById('noEventLogoText').style.display = 'block';
            }
            
            renderSportList();
            renderTeamManagement();
            new bootstrap.Modal(document.getElementById('settingsModal')).show();
        } else if (pass) {
            Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง' });
        }
    };

    // ===== Render Team Management (ใน Settings) =====
    function renderTeamManagement() {
        const container = document.getElementById('teamManagementContainer');
        const teams = systemSettings.teams || {};
        
        if (Object.keys(teams).length === 0) {
            container.innerHTML = '<p class="text-muted small text-center">ยังไม่มีทีม กดปุ่ม "เพิ่มทีมใหม่" เพื่อสร้างทีม</p>';
            return;
        }
        
        let html = '';
        Object.entries(teams).forEach(([key, team]) => {
            const statusBadge = team.active 
                ? '<span class="badge bg-success">ใช้งาน</span>' 
                : '<span class="badge bg-secondary">ปิดใช้งาน</span>';
            
            html += `
                <div class="d-flex align-items-center justify-content-between p-2 mb-2 border rounded bg-white">
                    <div class="d-flex align-items-center gap-2">
                        <div style="width: 30px; height: 30px; background: ${team.color}; border-radius: 5px;"></div>
                        <div>
                            <strong>${team.name}</strong>
                            <div class="small text-muted">${key}</div>
                        </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center">
                        ${statusBadge}
                        <button class="btn btn-sm btn-outline-primary" onclick="editTeam('${key}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTeam('${key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // ===== ฟังก์ชันจัดการทีม (เพิ่ม/แก้ไข/ลบ) =====
    window.addNewTeam = async () => {
        const { value: teamName } = await Swal.fire({
            title: 'เพิ่มทีมใหม่',
            input: 'text',
            inputLabel: 'ชื่อทีม',
            inputPlaceholder: 'เช่น สีแดง, คณะเหนือ',
            showCancelButton: true,
            inputValidator: (value) => { if (!value) return 'กรุณากรอกชื่อทีม'; }
        });
        
        if (teamName) {
            const teamKey = 'team' + (Object.keys(systemSettings.teams).length + 1) + '_' + Date.now().toString().slice(-4);
            const colors = ['#f44336', '#4caf50', '#ff9800', '#9c27b0', '#00bcd4', '#ffeb3b'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            
            systemSettings.teams[teamKey] = { name: teamName, color: randomColor, active: true };
            renderTeamManagement();
        }
    };

    window.editTeam = (key) => {
        const team = systemSettings.teams[key];
        document.getElementById('editTeamKey').value = key;
        document.getElementById('editTeamName').value = team.name;
        document.getElementById('editTeamColor').value = team.color;
        document.getElementById('editTeamActive').checked = team.active;
        new bootstrap.Modal(document.getElementById('teamManagementModal')).show();
    };

    window.saveTeamEdit = () => {
        const key = document.getElementById('editTeamKey').value;
        const name = document.getElementById('editTeamName').value;
        const color = document.getElementById('editTeamColor').value;
        const active = document.getElementById('editTeamActive').checked;
        
        if (!name) { Swal.fire({ icon: 'warning', title: 'กรุณากรอกชื่อทีม' }); return; }
        
        systemSettings.teams[key] = { name, color, active };
        renderTeamManagement();
        bootstrap.Modal.getInstance(document.getElementById('teamManagementModal')).hide();
        Swal.fire({ icon: 'success', title: 'บันทึกเรียบร้อย', timer: 1000, showConfirmButton: false });
    };

    window.deleteTeam = async (key) => {
        const result = await Swal.fire({
            title: 'ยืนยันการลบทีม?',
            text: 'การลบทีมจะส่งผลต่อข้อมูลการแข่งขันที่มีอยู่',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ลบ',
            cancelButtonText: 'ยกเลิก'
        });
        if (result.isConfirmed) {
            delete systemSettings.teams[key];
            renderTeamManagement();
            Swal.fire({ icon: 'success', title: 'ลบเรียบร้อย', timer: 1000, showConfirmButton: false });
        }
    };

    // ===== ฟังก์ชันจัดการรายการกีฬา =====
    function renderSportList() {
        const container = document.getElementById('sportListContainer');
        if (Object.keys(systemSettings.sports).length === 0) {
            container.innerHTML = '<p class="text-center text-muted small mb-0">ยังไม่มีรายการกีฬา</p>';
            return;
        }
        let html = '';
        Object.entries(systemSettings.sports).forEach(([key, name]) => {
            html += `
                <div class="d-flex justify-content-between align-items-center mb-1 border-bottom pb-1">
                    <div>
                        <span class="fw-bold">${name}</span>
                        <small class="text-muted ms-2">(${key})</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger py-0" onclick="removeSportFromList('${key}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    window.addSportToList = () => {
        const key = document.getElementById('newSportKey').value.trim().toLowerCase().replace(/\s+/g, '_');
        const name = document.getElementById('newSportName').value.trim();
        
        if (!key || !name) { Swal.fire({ icon: 'warning', title: 'กรุณากรอกข้อมูลให้ครบ' }); return; }
        if (systemSettings.sports[key]) { Swal.fire({ icon: 'warning', title: 'รหัสกีฬานี้มีอยู่แล้ว' }); return; }
        
        systemSettings.sports[key] = name;
        renderSportList();
        document.getElementById('newSportKey').value = '';
        document.getElementById('newSportName').value = '';
    };

    window.removeSportFromList = (key) => {
        if (confirm(`ลบกีฬา "${systemSettings.sports[key]}" ?`)) {
            delete systemSettings.sports[key];
            renderSportList();
        }
    };

    // ===== ฟังก์ชันจัดการรูปภาพ =====
    window.previewLogo = (type) => {
        const input = document.getElementById(type === 'school' ? 'settingSchoolLogo' : 'settingEventLogo');
        const preview = document.getElementById(type === 'school' ? 'previewSchoolLogo' : 'previewEventLogo');
        const noText = document.getElementById('noEventLogoText');
        
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
                if (type === 'event' && noText) noText.style.display = 'none';
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    window.saveSettings = async () => {
        systemSettings.schoolName = document.getElementById('settingSchoolName').value || systemSettings.schoolName;
        systemSettings.eventName = document.getElementById('settingEventName').value || systemSettings.eventName;
        systemSettings.academicYear = document.getElementById('settingAcademicYear').value || systemSettings.academicYear;
        systemSettings.password = document.getElementById('settingPassword').value || systemSettings.password;
        
        const schoolLogoInput = document.getElementById('settingSchoolLogo');
        const eventLogoInput = document.getElementById('settingEventLogo');
        
        if (schoolLogoInput.files && schoolLogoInput.files[0]) systemSettings.schoolLogo = await fileToBase64(schoolLogoInput.files[0]);
        if (eventLogoInput.files && eventLogoInput.files[0]) systemSettings.eventLogo = await fileToBase64(eventLogoInput.files[0]);
        
        set(ref(db, 'settings'), systemSettings).then(() => {
            applySettingsToUI();
            updateSportDropdown();
            updateScheduleDropdowns();
            renderTeamSummaryCards();
            Swal.fire({ icon: 'success', title: 'บันทึกการตั้งค่าเรียบร้อย', timer: 1500, showConfirmButton: false });
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        }).catch((error) => {
            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
        });
    };
// ===== Toggle Set Count =====
    window.toggleSetCount = () => {
        const method = document.getElementById('scoringMethod').value;
        const container = document.getElementById('setCountContainer');
        if (method === 'score_set' || method === 'win_set') {
            container.classList.remove('d-none');
        } else {
            container.classList.add('d-none');
        }
    };

    // ===== ฟังก์ชันแปลงวันที่ =====
    window.getThaiDate = () => {
        const date = new Date();
        const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        const day = date.getDate();
        const month = months[date.getMonth()];
        const year = date.getFullYear() + 543;
        return `${day} ${month} ${year}`;
    };
    
    function formatDateThai(dateStr) {
        if(!dateStr) return '';
        const d = new Date(dateStr);
        return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
    }

    function formatDateThaiLong(dateStr) {
        if(!dateStr) return '';
        const d = new Date(dateStr);
        const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
        return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()+543}`;
    }

    function getScoringMethodName(method) {
        const methods = {
            'score_set': 'ลงคะแนน Set',
            'win_set': 'ชนะ/แพ้ Set',
            'score_once': 'ลงคะแนนรอบเดียว',
            'win_once': 'ชนะ/แพ้รอบเดียว'
        };
        return methods[method] || method;
    }
    
    // ===== พิมพ์เอกสาร =====
    window.printDocument = (elementId) => {
        const element = document.getElementById(elementId);
        const printWindow = window.open('', '', 'width=900,height=700');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>พิมพ์เอกสาร - ${systemSettings.eventName} ${systemSettings.academicYear}</title>
                <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
                <style>
                    @page { size: A4; margin: 10mm 15mm; }
                    body { font-family: 'Kanit', sans-serif; margin: 0; padding: 0; background: white; line-height: 1.5; color: #000 !important; }
                    @media print { 
                        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
                        .no-print { display: none; }
                    }
                    table { border-collapse: collapse; width: 100%; }
                    h1, h2, h3, h4, h5, h6 { color: #000 !important; }
                </style>
            </head>
            <body>${element.innerHTML}</body>
            </html>
        `);
        
        printWindow.document.close();
        setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
    };

    window.forceHideLoader = () => {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 300);
        }
    };

    window.getSportName = (k) => systemSettings.sports[k] || k;

    window.showManual = () => {
        Swal.fire({
            title: 'คู่มือการใช้งาน',
            html: `<ul class="text-start small">
                <li><b>เพิ่มรายการ:</b> สร้างรายการแข่งใหม่ (เลือกทีมที่เข้าแข่งได้)</li>
                <li><b>แก้ไขรายการ:</b> กดปุ่มสีฟ้า > แก้ไขรายละเอียด</li>
                <li><b>ลงทะเบียน:</b> แท็บ "รายชื่อ" กด + เพิ่มนักกีฬา</li>
                <li><b>ลงคะแนน:</b> กดปุ่มปลดล็อก > ใส่รหัส</li>
                <li><b>ตั้งค่าระบบ:</b> ปรับชื่อโรงเรียน/กิจกรรม/กีฬา/ทีม</li>
                <li><b>จัดการทีม:</b> เพิ่ม/แก้ไข/ลบทีม เปิด/ปิดใช้งานทีม</li>
                <li><b>ส่งออก Excel:</b> บันทึกข้อมูลทั้งหมดเป็นไฟล์ Excel</li>
                <li><b>นำเข้า Excel:</b> โหลดข้อมูลจากไฟล์ที่ส่งออก</li>
                <li><b>ล้างข้อมูล:</b> Reset สำหรับปีการศึกษาใหม่</li>
            </ul>`,
            confirmButtonText: 'เข้าใจแล้ว'
        });
    };

    // ===== QR Code =====
    window.showQRCode = () => {
        const currentUrl = window.location.href;
        const path = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
        const registerUrl = `${path}/register.html`;

        const html = `
            <div class="row g-3">
                <div class="col-12 col-md-6">
                    <div class="p-3 border rounded bg-light h-100">
                        <h6 class="fw-bold text-primary mb-2">1. ระบบจัดการ (สำหรับครู/กรรมการ)</h6>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentUrl)}" class="img-fluid mb-2 border bg-white p-1">
                        <p class="small text-muted mb-0">ใช้บันทึกผลและจัดการการแข่งขัน</p>
                    </div>
                </div>
                <div class="col-12 col-md-6">
                    <div class="p-3 border rounded bg-white h-100 shadow-sm border-warning">
                        <h6 class="fw-bold text-warning-emphasis mb-2">2. จุดลงทะเบียนนักกีฬา</h6>
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(registerUrl)}" class="img-fluid mb-2 border bg-white p-1">
                        <p class="small text-muted mb-2">ให้นักเรียนสแกนเพื่อกรอกชื่อ</p>
                        <a href="${registerUrl}" target="_blank" class="btn btn-sm btn-outline-dark w-100">เปิดหน้าลงทะเบียน</a>
                    </div>
                </div>
            </div>
        `;

        const modalDialog = document.querySelector('#qrModal .modal-dialog');
        modalDialog.classList.remove('modal-sm');
        modalDialog.classList.add('modal-lg');
        
        document.querySelector('#qrModal .modal-body').innerHTML = html;
        new bootstrap.Modal(document.getElementById('qrModal')).show();
    };

    // ===== โหลดรายการแข่งขัน =====
    function loadMatches() {
        onValue(ref(db, 'matches'), (snap) => {
            forceHideLoader();
            const data = snap.val();
            allMatchesData = data || {};
            if(data) {
                allMatchesArray = Object.keys(data).map(k => ({...data[k], id: k}));
                allMatchesArray.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
            } else {
                allMatchesArray = [];
            }
            updateFilterOptions();
            updateScheduleDropdowns();
            renderMatchList();
            renderTeamSummaryCards();
        }, (error) => {
            forceHideLoader();
            Swal.fire('Error', 'เชื่อมต่อ Firebase ไม่ได้', 'error');
        });
    }

    function updateFilterOptions() {
        const filterSportSel = document.getElementById('filterSport');
        const currentSport = filterSportSel.value;
        filterSportSel.innerHTML = '<option value="all">ทุกกีฬา</option>';
        const sports = [...new Set(allMatchesArray.map(m => m.sport))];
        sports.forEach(s => { filterSportSel.innerHTML += `<option value="${s}">${getSportName(s)}</option>`; });
        if([...filterSportSel.options].some(o => o.value === currentSport)) filterSportSel.value = currentSport;

        const filterDateSel = document.getElementById('filterDate');
        const currentDate = filterDateSel.value;
        filterDateSel.innerHTML = '<option value="all">ทุกวัน</option>';
        const dates = [...new Set(allMatchesArray.map(m => m.date))].sort();
        dates.forEach(d => { filterDateSel.innerHTML += `<option value="${d}">${formatDateThai(d)}</option>`; });
        if([...filterDateSel.options].some(o => o.value === currentDate)) filterDateSel.value = currentDate;
    }

    // ===== แสดงรายการแข่งขัน =====
    window.renderMatchList = () => {
        const filterS = document.getElementById('filterSport').value;
        const filterW = document.getElementById('filterWinner').value;
        const filterD = document.getElementById('filterDate').value;
        const filterM = document.getElementById('filterScoringMethod').value;
        const list = document.getElementById('matchList');
        list.innerHTML = '';
        
        if(allMatchesArray.length === 0) {
            list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ไม่พบข้อมูล<br><small>กดปุ่ม "เพิ่มรายการ" เพื่อสร้างใหม่</small></td></tr>';
            renderTeamSummaryCards();
            return;
        }

        let displayCount = 0;
        allMatchesArray.forEach(m => {
            if(filterS !== 'all' && m.sport !== filterS) return;
            if(filterW !== 'all' && m.winner !== filterW) return;
            if(filterD !== 'all' && m.date !== filterD) return;
            if(filterM !== 'all' && (m.scoringMethod || 'score_once') !== filterM) return;

            displayCount++;
            
            const matchTeams = m.teams || ['team1', 'team2'];
            const scores = matchTeams.map(tk => {
                const team = getTeamByKey(tk);
                const score = m.scores?.[tk] || 0;
                return { key: tk, name: team.name, color: team.color, score };
            });
            
            const scoreDisplay = scores.map(s => `${s.score}`).join(' - ');
            
            let winnerDisplay = '-';
            if (m.status === 'done' && m.winner) {
                if(m.winner === 'draw') {
                    winnerDisplay = '<span class="fw-bold text-secondary">เสมอ</span>';
                } else {
                    const winTeam = getTeamByKey(m.winner);
                    winnerDisplay = `<span class="fw-bold" style="color: ${winTeam.color};">●</span>`;
                }
            }
            
            let badge = m.status === 'done' ? '<span class="status-badge bg-done">จบ</span>' : '<span class="status-badge bg-wait">รอ</span>';
            const hasRefs = m.referees && m.referees.some(r => r.trim() !== '');
            const refIcon = hasRefs ? '<i class="fas fa-whistle text-success me-1"></i>' : '<i class="fas fa-whistle text-secondary opacity-25 me-1"></i>';
            
            let hasPlayers = false;
            if (m.players) {
                Object.values(m.players).forEach(pArr => {
                    if (pArr && pArr.some(p => p.trim() !== '')) hasPlayers = true;
                });
            }
            const playerIcon = hasPlayers ? '<i class="fas fa-users text-success"></i>' : '<i class="fas fa-users text-secondary opacity-25"></i>';

            list.innerHTML += `
                <tr>
                    <td>${m.time || '-'}<br>${badge}</td>
                    <td>
                        <strong style="font-size: 0.9em;">${getSportName(m.sport)}</strong>
                        <br><small class="text-muted">${m.category || '-'}</small>
                        <div class="mt-1 small">${refIcon} ${playerIcon}</div>
                    </td>
                    <td class="text-center"><span class="badge bg-light text-dark border">${scoreDisplay}</span></td>
                    <td class="text-center">${winnerDisplay}</td>
                    <td class="text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-copy"></i></button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="copyMatchText('${m.id}', 'schedule')">คัดลอกกำหนดการ</a></li>
                                <li><a class="dropdown-item" href="#" onclick="copyMatchText('${m.id}', 'result')">คัดลอกผลการแข่งขัน</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" onclick="editMatchDetails('${m.id}')">แก้ไขรายละเอียด</a></li>
                            </ul>
                            <button class="btn btn-outline-dark" onclick="openMatch('${m.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-outline-danger" onclick="deleteMatch('${m.id}')"><i class="fas fa-trash"></i></button>
                            ${m.status === 'done' ? `<button class="btn btn-danger" onclick="previewReport('${m.id}')"><i class="fas fa-print"></i></button>` : ''}
                        </div>
                    </td>
                </tr>`;
        });
        
        if(displayCount === 0) list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ไม่พบรายการที่ตรงกับตัวกรอง</td></tr>';
        renderTeamSummaryCards();
    };

    window.applyFilters = () => { renderMatchList(); };

    // ===== เพิ่ม/แก้ไขรายการแข่งขัน =====
    window.prepareAddMatch = () => {
        editingMatchId = null;
        document.getElementById('setupForm').reset();
        document.getElementById('setupTitle').innerHTML = '<i class="fas fa-calendar-plus"></i> เพิ่มรายการแข่งขัน';
        document.getElementById('setupSubmitBtn').innerText = 'บันทึก';
        document.getElementById('matchDate').value = new Date().toISOString().slice(0,10);
        document.getElementById('setCountContainer').classList.add('d-none');
        updateSportDropdown();
        renderTeamSelection();
        showPage('setup');
    };

    window.editMatchDetails = (id) => {
        const m = allMatchesArray.find(x => x.id === id);
        if(!m) return;
        editingMatchId = id;
        updateSportDropdown();
        document.getElementById('sportType').value = m.sport;
        document.getElementById('category').value = m.category;
        document.getElementById('matchDate').value = m.date;
        document.getElementById('matchTime').value = m.time;
        document.getElementById('location').value = m.location || '';
        document.getElementById('scoringMethod').value = m.scoringMethod || 'score_once';
        toggleSetCount();
        if (m.setCount) document.getElementById('setCount').value = m.setCount;
        
        renderTeamSelection();
        
        // เลือกทีมที่ใช้ในการแข่งขันนี้
        if (m.teams && m.teams.length > 0) {
            document.querySelectorAll('.team-checkbox').forEach(cb => {
                cb.checked = m.teams.includes(cb.value);
            });
        } else {
            // ถ้าเป็นข้อมูลเก่าที่ไม่มี teams ให้เลือก default
            document.querySelectorAll('.team-checkbox').forEach((cb, idx) => {
                cb.checked = idx < 2;
            });
        }
        
        document.getElementById('setupTitle').innerHTML = '<i class="fas fa-edit"></i> แก้ไขรายละเอียด';
        document.getElementById('setupSubmitBtn').innerText = 'บันทึกการแก้ไข';
        showPage('setup');
    };

    document.getElementById('setupForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const sport = document.getElementById('sportType').value;
        const category = document.getElementById('category').value;
        const matchDate = document.getElementById('matchDate').value;
        const matchTime = document.getElementById('matchTime').value;
        const location = document.getElementById('location').value;
        const scoringMethod = document.getElementById('scoringMethod').value;
        const setCount = parseInt(document.getElementById('setCount').value) || 3;
        
        // รับทีมที่เลือก
        const selectedTeams = [];
        document.querySelectorAll('.team-checkbox:checked').forEach(cb => {
            selectedTeams.push(cb.value);
        });
        
        if (selectedTeams.length < 2) {
            Swal.fire({ icon: 'warning', title: 'กรุณาเลือกอย่างน้อย 2 ทีม' });
            return;
        }
        
        if(!sport || !category || !matchDate || !matchTime || !scoringMethod) { 
            Swal.fire('กรุณากรอกข้อมูลให้ครบ', '', 'warning'); 
            return; 
        }
        
        if(editingMatchId) {
            const updateData = { 
                sport, category, date: matchDate, time: matchTime, location: location || '', 
                scoringMethod, teams: selectedTeams 
            };
            if (scoringMethod === 'score_set' || scoringMethod === 'win_set') updateData.setCount = setCount;
            
            update(ref(db, `matches/${editingMatchId}`), updateData).then(() => {
                Swal.fire({ icon: 'success', title: 'บันทึกการแก้ไขเรียบร้อย', timer: 1500, showConfirmButton: false });
                editingMatchId = null;
                document.getElementById('setupForm').reset();
                showPage('dashboard');
            }).catch((error) => { Swal.fire('Error', 'ไม่สามารถแก้ไขได้', 'error'); });
        } else {
            let refs = sport === 'cheer' ? ['','','','',''] : ['']; 
            
            const scores = {};
            const players = {};
            selectedTeams.forEach(tk => {
                scores[tk] = 0;
                players[tk] = [];
            });
            
            const newMatch = {
                sport, category, date: matchDate, time: matchTime, location: location || '',
                status: 'wait', 
                scores: scores,
                winner: 'none',
                scoringMethod: scoringMethod,
                details: {}, 
                referees: refs, 
                athleteSign: '', 
                note: '', 
                players: players,
                teams: selectedTeams,
                createdAt: new Date().toISOString()
            };
            if (scoringMethod === 'score_set' || scoringMethod === 'win_set') newMatch.setCount = setCount;
            
            push(ref(db, 'matches'), newMatch).then(() => {
                Swal.fire({ icon: 'success', title: 'เพิ่มรายการเรียบร้อย', timer: 1500, showConfirmButton: false });
                document.getElementById('setupForm').reset();
                document.getElementById('matchDate').value = new Date().toISOString().slice(0,10);
                showPage('dashboard');
            }).catch((error) => { Swal.fire('Error', 'ไม่สามารถเพิ่มรายการได้', 'error'); });
        }
    });

    window.deleteMatch = async (id) => {
        const { value: pass } = await Swal.fire({
            title: 'ยืนยันการลบรายการ?',
            text: 'การกระทำนี้ไม่สามารถกู้คืนได้ กรุณาใส่รหัสผ่านเพื่อยืนยัน',
            input: 'password',
            inputPlaceholder: 'รหัสผ่าน...',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'ลบรายการ',
            cancelButtonText: 'ยกเลิก'
        });
        if (pass === systemSettings.password) {
            remove(ref(db, 'matches/'+id)).then(() => { 
                Swal.fire({ icon: 'success', title: 'ลบเรียบร้อย', timer: 1000, showConfirmButton: false }); 
            });
        } else if (pass) { 
            Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง' }); 
        }
    };

    // ===== Initialization =====
    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(forceHideLoader, 5000);
        loadSettings();
        loadMatches();
    });
    
    // ===== เปิดหน้าลงคะแนน =====
    window.openMatch = (id) => {
        currentMatchId = id;
        isMatchUnlocked = false;
        onValue(ref(db, 'matches/'+id), (snap) => {
            const m = snap.val();
            if(!m) return;
            
            // กำหนดค่า default
            m.players = m.players || {};
            m.scores = m.scores || {};
            m.referees = m.referees || [''];
            m.details = m.details || {};
            m.teams = m.teams || ['team1', 'team2'];
            
            matchDataLocal = m;
            
            // อัพเดทหัวข้อ
            document.getElementById('matchTitleDisplay').innerText = getSportName(m.sport);
            document.getElementById('matchCatDisplay').innerText = m.category;
            document.getElementById('matchNote').value = m.note || '';
            document.getElementById('athleteSign').value = m.athleteSign || '';
            
            // กรรมการ
            const refDiv = document.getElementById('refereeInputs');
            refDiv.innerHTML = '';
            const refCount = (m.sport === 'cheer') ? 5 : 1;
            let currentRefs = m.referees || [];
            while(currentRefs.length < refCount) currentRefs.push('');
            currentRefs.forEach((name, i) => { 
                if(i < refCount) refDiv.innerHTML += `<input type="text" class="form-control form-control-sm mb-2" placeholder="กรรมการ ${i+1}" value="${name}" id="refInput_${i}">`; 
            });

            document.getElementById('signerLabel').innerText = (m.sport === 'cheer') ? "ประธานสีผู้รับรอง" : "ตัวแทนนักกีฬาผู้ชนะ";
            
            renderPlayersTab(m);
            renderScoreDisplay(m);
            renderScoreControls(m);
            
            showPage('match');
        }, { onlyOnce: true });
    };

    // ===== แสดงคะแนน =====
    function renderScoreDisplay(m) {
        const container = document.getElementById('scoreDisplayArea');
        const teams = m.teams || ['team1', 'team2'];
        
        if (teams.length === 2) {
            const team1 = getTeamByKey(teams[0]);
            const team2 = getTeamByKey(teams[1]);
            const score1 = m.scores?.[teams[0]] || 0;
            const score2 = m.scores?.[teams[1]] || 0;
            
            container.innerHTML = `
                <div class="row align-items-center g-2">
                    <div class="col-5">
                        <div class="p-2 p-md-3 rounded border bg-opacity-10" style="border-color: ${team1.color}!important; background: ${team1.color};">
                            <h5 class="fw-bold text-dark mb-1" style="font-size: clamp(0.85rem, 3vw, 1.25rem);">${team1.name}</h5>
                            <div class="display-3 fw-bold" id="scoreDisplay_${teams[0]}">${score1}</div>
                        </div>
                    </div>
                    <div class="col-2"><h2 class="text-muted opacity-50 mb-0">VS</h2></div>
                    <div class="col-5">
                        <div class="p-2 p-md-3 rounded border bg-opacity-10" style="border-color: ${team2.color}!important; background: ${team2.color};">
                            <h5 class="fw-bold text-dark mb-1" style="font-size: clamp(0.85rem, 3vw, 1.25rem);">${team2.name}</h5>
                            <div class="display-3 fw-bold" id="scoreDisplay_${teams[1]}">${score2}</div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            let html = '<div class="row g-2">';
            teams.forEach(tk => {
                const team = getTeamByKey(tk);
                const score = m.scores?.[tk] || 0;
                const colSize = Math.floor(12 / teams.length);
                html += `
                    <div class="col-${colSize}">
                        <div class="p-2 rounded border text-center" style="border-color: ${team.color}!important;">
                            <h6 class="fw-bold mb-1" style="color: ${team.color};">${team.name}</h6>
                            <div class="fs-1 fw-bold" id="scoreDisplay_${tk}">${score}</div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
    }

    // ===== แสดงแท็บรายชื่อนักกีฬา =====
    function renderPlayersTab(m) {
        const container = document.getElementById('playersTabContent');
        const teams = m.teams || ['team1', 'team2'];
        
        let html = '';
        teams.forEach(tk => {
            const team = getTeamByKey(tk);
            html += `
                <div class="mb-3">
                    <h6 class="small fw-bold d-flex justify-content-between align-items-center border-bottom pb-2" style="border-color: ${team.color}!important;">
                        <span style="color: ${team.color};"><i class="fas fa-users me-1"></i> นักกีฬา${team.name}</span>
                        <button class="btn btn-sm py-0" style="background: ${team.color}; color: white;" onclick="addPlayerInput('${tk}')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </h6>
                    <div id="players_${tk}" class="d-flex flex-column gap-2 mt-2"></div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        teams.forEach(tk => {
            const players = m.players?.[tk] || [];
            renderPlayers(players, tk);
        });
    }

    window.renderPlayers = (list, teamKey) => {
        const div = document.getElementById(`players_${teamKey}`);
        if (!div) return;
        
        div.innerHTML = '';
        const safeList = Array.isArray(list) ? list : []; 
        
        if(safeList.length === 0) { 
            div.innerHTML = '<small class="text-muted fst-italic">ไม่มีรายชื่อ (กด + เพิ่ม)</small>'; 
        } else {
            safeList.forEach((p, i) => {
                div.innerHTML += `
                    <div class="input-group input-group-sm mb-1">
                        <span class="input-group-text" style="min-width:30px;">${i+1}</span>
                        <input type="text" class="form-control" value="${p || ''}" 
                               onchange="updatePlayer('${teamKey}', ${i}, this.value)" 
                               placeholder="ชื่อ-สกุล">
                        <button class="btn btn-outline-danger" onclick="removePlayer('${teamKey}', ${i})">×</button>
                    </div>
                `;
            });
        }
    };

    window.addPlayerInput = (teamKey) => {
        if (!currentMatchId) return;
        if (!matchDataLocal.players) matchDataLocal.players = {};
        if (!Array.isArray(matchDataLocal.players[teamKey])) matchDataLocal.players[teamKey] = [];
        
        matchDataLocal.players[teamKey].push('');
        set(ref(db, `matches/${currentMatchId}/players/${teamKey}`), matchDataLocal.players[teamKey]).then(() => { 
            renderPlayers(matchDataLocal.players[teamKey], teamKey); 
        });
    };

    window.updatePlayer = (teamKey, idx, val) => {
        if (!matchDataLocal.players) matchDataLocal.players = {};
        if (!Array.isArray(matchDataLocal.players[teamKey])) matchDataLocal.players[teamKey] = [];
        matchDataLocal.players[teamKey][idx] = val;
        set(ref(db, `matches/${currentMatchId}/players/${teamKey}`), matchDataLocal.players[teamKey]);
    };

    window.removePlayer = (teamKey, idx) => {
        if (!matchDataLocal.players || !Array.isArray(matchDataLocal.players[teamKey])) return;
        matchDataLocal.players[teamKey].splice(idx, 1);
        set(ref(db, `matches/${currentMatchId}/players/${teamKey}`), matchDataLocal.players[teamKey]).then(() => { 
            renderPlayers(matchDataLocal.players[teamKey], teamKey); 
        });
    };

    window.saveMatchInfo = () => {
        const refs = [];
        document.querySelectorAll('[id^="refInput_"]').forEach(input => refs.push(input.value));
        update(ref(db, `matches/${currentMatchId}`), { 
            referees: refs, 
            athleteSign: document.getElementById('athleteSign').value, 
            note: document.getElementById('matchNote').value 
        }).then(() => {
            Swal.fire({ icon: 'success', title: 'บันทึกเรียบร้อย', timer: 1200, showConfirmButton: false });
            matchDataLocal.referees = refs; // Update local state
        });
    };

    // ===== ระบบลงคะแนน =====
    function renderScoreControls(m) {
        const div = document.getElementById('dynamicScoreControls');
        
        if (!isMatchUnlocked && m.status !== 'done') {
            div.innerHTML = `
                <div class="text-center py-4 bg-light rounded border border-warning border-dashed">
                    <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                    <h5>ล็อกการบันทึกผล</h5>
                    <p class="text-muted small mb-3">ป้องกันนักเรียนแก้ไขผลการแข่งขัน</p>
                    <button class="btn btn-warning fw-bold px-4" onclick="unlockScore()">
                        <i class="fas fa-key me-2"></i> ปลดล็อก (สำหรับกรรมการ)
                    </button>
                </div>
            `;
            document.querySelector('button[onclick="finishMatch()"]').style.display = 'none';
            return;
        } else {
            document.querySelector('button[onclick="finishMatch()"]').style.display = 'block';
        }

        let html = '';
        const scoringMethod = m.scoringMethod || 'score_once';
        const setCount = m.setCount || 3;
        const teams = m.teams || ['team1', 'team2'];
        
        if(m.sport === 'cheer') {
            html = `<h6 class="border-bottom pb-2 mb-2">คะแนนกรรมการ 5 ท่าน</h6>`;
            html += '<div class="row g-2 text-center mb-1"><div class="col-6 offset-6 d-flex">';
            teams.forEach(tk => {
                const team = getTeamByKey(tk);
                html += `<div class="flex-fill"><strong class="small" style="color: ${team.color};">${team.name}</strong></div>`;
            });
            html += '</div></div>';
            
            for(let i=1; i<=5; i++) { 
                let refName = (m.referees && m.referees[i-1]) ? m.referees[i-1] : `กรรมการท่านที่ ${i}`;
                html += `<div class="row g-2 align-items-center mb-2">
                    <div class="col-6 text-start"><span class="small fw-bold text-muted"><i class="fas fa-user-circle"></i> ${refName}</span></div>`;
                
                teams.forEach(tk => {
                    const team = getTeamByKey(tk);
                    html += `<div class="col-${Math.floor(6/teams.length)}">
                        <input type="number" class="form-control form-control-sm text-center" 
                               style="border-color: ${team.color};"
                               placeholder="0" value="${m.details?.[`j${i}_${tk}`]||0}" 
                               onchange="updateCheerScore(${i}, '${tk}', this.value)">
                    </div>`;
                });
                html += '</div>';
            }
        }
        else if (scoringMethod === 'score_set') {
            html = `<h6 class="border-bottom pb-2 mb-2">คะแนนรายเซต (${setCount} Set)</h6>`;
            for(let i=1; i<=setCount; i++) { 
                html += `<div class="d-flex align-items-center mb-2 gap-2"><span class="fw-bold small" style="width:45px">SET ${i}</span>`;
                teams.forEach((tk, idx) => {
                    html += `<input type="number" class="form-control form-control-sm text-center" 
                                   value="${m.details?.[`s${i}_${tk}`]||0}" 
                                   onchange="updateSetPoint(${i}, '${tk}', this.value, ${setCount})">`;
                    if (idx < teams.length - 1) html += '<span>:</span>';
                });
                html += '</div>';
            }
        }
        else if (scoringMethod === 'win_set') {
            html = `<h6 class="border-bottom pb-2 mb-2">ผู้ชนะรายเซต (${setCount} Set)</h6>`;
            for(let i=1; i<=setCount; i++) { 
                let w = m.details?.[`set${i}`] || 'none';
                html += `<div class="d-flex justify-content-between align-items-center mb-2 p-2 border rounded">
                    <span class="fw-bold small">Set ${i}</span>
                    <div class="btn-group btn-group-sm">`;
                
                teams.forEach(tk => {
                    const team = getTeamByKey(tk);
                    html += `
                        <input type="radio" class="btn-check" name="s${i}" id="s${i}_${tk}" 
                               ${w===tk?'checked':''} onchange="updateSetWin(${i}, '${tk}', ${setCount})">
                        <label class="btn btn-outline-secondary" for="s${i}_${tk}" 
                               style="border-color: ${team.color}; color: ${team.color};">
                            ${team.name}
                        </label>
                    `;
                });
                
                html += `
                        <input type="radio" class="btn-check" name="s${i}" id="s${i}_none" 
                               ${w==='none'?'checked':''} onchange="updateSetWin(${i}, 'none', ${setCount})">
                        <label class="btn btn-outline-secondary" for="s${i}_none">-</label>
                    </div></div>`;
            }
        }
        else if (scoringMethod === 'win_once') {
            html = `<div class="text-center"><h6 class="border-bottom pb-2 mb-3">เลือกผู้ชนะ</h6>
                    <div class="btn-group w-100" role="group">`;
            
            teams.forEach(tk => {
                const team = getTeamByKey(tk);
                const score = m.scores?.[tk] || 0;
                const isWinner = score > 0;
                
                html += `
                    <input type="radio" class="btn-check" name="simpleWin" id="win_${tk}" 
                           ${isWinner ? 'checked' : ''} onchange="setSimpleWinner('${tk}')">
                    <label class="btn btn-outline-secondary py-3" for="win_${tk}" 
                           style="border-color: ${team.color}; color: ${team.color};">
                        <i class="fas fa-trophy me-2"></i>${team.name}ชนะ
                    </label>
                `;
            });
            
            html += '</div></div>';
        }
        else {
            const colSize = Math.floor(12 / teams.length);
            html = `<div class="row text-center g-2">`;
            
            teams.forEach(tk => {
                const team = getTeamByKey(tk);
                html += `
                    <div class="col-${colSize}">
                        <button class="btn w-100 py-3 fw-bold" 
                                style="background: ${team.color}; color: white; border: none;"
                                onclick="manualScore('${tk}', 1)">
                            +1 ${team.name}
                        </button>
                    </div>
                `;
            });
            
            html += '</div><div class="row text-center g-2 mt-2">';
            
            teams.forEach(tk => {
                const team = getTeamByKey(tk);
                html += `
                    <div class="col-${colSize}">
                        <button class="btn btn-sm btn-outline-secondary w-100" 
                                onclick="manualScore('${tk}', -1)">-1</button>
                    </div>
                `;
            });
            
            html += '</div>';
        }
        
        div.innerHTML = html;
    }

    window.unlockScore = async () => {
        const { value: pass } = await Swal.fire({ 
            title: 'ใส่รหัสผ่านกรรมการ', 
            input: 'password', 
            inputPlaceholder: 'รหัสผ่าน...', 
            showCancelButton: true, 
            confirmButtonText: 'ปลดล็อก' 
        });
        if (pass === systemSettings.password) { 
            isMatchUnlocked = true; 
            renderScoreControls(matchDataLocal); 
            Swal.fire({ icon: 'success', title: 'ปลดล็อกเรียบร้อย', timer: 1000, showConfirmButton: false }); 
        } else if (pass) { 
            Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง' }); 
        }
    };

    // ===== ฟังก์ชันลงคะแนน (แก้ไขให้ update matchDataLocal ทันที) =====
    
    window.setSimpleWinner = (teamKey) => {
        const teams = matchDataLocal.teams || [];
        const updates = { scores: {} };
        
        // Update Local State
        if (!matchDataLocal.scores) matchDataLocal.scores = {};
        teams.forEach(tk => {
            matchDataLocal.scores[tk] = (tk === teamKey) ? 1 : 0;
            updates.scores[tk] = matchDataLocal.scores[tk];
        });
        
        // Update Display
        teams.forEach(tk => {
            const el = document.getElementById(`scoreDisplay_${tk}`);
            if (el) el.innerText = matchDataLocal.scores[tk];
        });
        
        update(ref(db, `matches/${currentMatchId}`), updates);
    };

    window.updateCheerScore = (judgeNum, teamKey, value) => {
        if(!matchDataLocal.details) matchDataLocal.details = {};
        matchDataLocal.details[`j${judgeNum}_${teamKey}`] = parseInt(value) || 0; // Update local state
        
        update(ref(db, `matches/${currentMatchId}/details`), matchDataLocal.details).then(() => {
            // Calculate total
            const teams = matchDataLocal.teams || [];
            const scores = {};
            
            teams.forEach(tk => {
                let sum = 0;
                for(let i=1; i<=5; i++) {
                    sum += (matchDataLocal.details[`j${i}_${tk}`] || 0);
                }
                scores[tk] = sum;
                matchDataLocal.scores[tk] = sum; // Update local scores
                
                const el = document.getElementById(`scoreDisplay_${tk}`);
                if (el) el.innerText = sum;
            });
            
            update(ref(db, `matches/${currentMatchId}`), { scores });
        });
    };

    window.updateSetPoint = (setNum, teamKey, value, setCount = 3) => {
        if(!matchDataLocal.details) matchDataLocal.details = {};
        matchDataLocal.details[`s${setNum}_${teamKey}`] = parseInt(value) || 0; // Update local state
        
        update(ref(db, `matches/${currentMatchId}/details`), matchDataLocal.details).then(() => {
            // Calculate Set Wins
            const teams = matchDataLocal.teams || [];
            const wins = {};
            teams.forEach(tk => wins[tk] = 0);
            
            for(let i=1; i<=setCount; i++) {
                let maxScore = 0;
                let winner = null;
                
                teams.forEach(tk => {
                    const score = matchDataLocal.details[`s${i}_${tk}`] || 0;
                    if (score > maxScore) {
                        maxScore = score;
                        winner = tk;
                    } else if (score === maxScore) {
                        winner = null;
                    }
                });
                
                if (winner) wins[winner]++;
            }
            
            matchDataLocal.scores = wins; // Update local scores
            
            teams.forEach(tk => {
                const el = document.getElementById(`scoreDisplay_${tk}`);
                if (el) el.innerText = wins[tk];
            });
            
            update(ref(db, `matches/${currentMatchId}`), { scores: wins });
        });
    };

    window.updateSetWin = (setNum, winner, setCount = 3) => {
        if(!matchDataLocal.details) matchDataLocal.details = {};
        matchDataLocal.details[`set${setNum}`] = winner; // Update local state
        
        const teams = matchDataLocal.teams || [];
        const wins = {};
        teams.forEach(tk => wins[tk] = 0);
        
        for(let i=1; i<=setCount; i++) {
            const w = matchDataLocal.details[`set${i}`];
            if (w && w !== 'none' && teams.includes(w)) {
                wins[w]++;
            }
        }
        
        matchDataLocal.scores = wins; // Update local scores
        
        teams.forEach(tk => {
            const el = document.getElementById(`scoreDisplay_${tk}`);
            if (el) el.innerText = wins[tk];
        });
        
        update(ref(db, `matches/${currentMatchId}`), { scores: wins, details: matchDataLocal.details });
    };

    window.manualScore = (teamKey, delta) => {
        if (!matchDataLocal.scores) matchDataLocal.scores = {};
        
        const newVal = Math.max(0, (matchDataLocal.scores[teamKey] || 0) + delta);
        matchDataLocal.scores[teamKey] = newVal; // Update local state
        
        const el = document.getElementById(`scoreDisplay_${teamKey}`);
        if (el) el.innerText = newVal;
        
        update(ref(db, `matches/${currentMatchId}`), { scores: matchDataLocal.scores });
    };

    window.clearMatchData = () => { 
        if(confirm('ล้างคะแนน?')) {
            const teams = matchDataLocal.teams || [];
            const scores = {};
            teams.forEach(tk => scores[tk] = 0);
            
            // Update local state
            matchDataLocal.scores = scores;
            matchDataLocal.details = {};
            
            update(ref(db, `matches/${currentMatchId}`), { scores, details: {} }); 
            
            teams.forEach(tk => {
                const el = document.getElementById(`scoreDisplay_${tk}`);
                if (el) el.innerText = '0';
            });
            renderScoreControls(matchDataLocal);
        } 
    };
    
    // ===== จบการแข่งขัน (แก้ไขปัญหา Issue 3: สีเทาเสมอ) =====
    window.finishMatch = () => {
        // ใช้ matchDataLocal ที่อัพเดทล่าสุดแล้ว
        let m = matchDataLocal;
        const teams = m.teams || [];
        const scores = m.scores || {};
        
        let warningText = "โปรดตรวจสอบให้แน่ใจว่าลงผลการแข่งขันครบถ้วนแล้ว";
        const scoringMethod = m.scoringMethod || 'score_once';
        const setCount = m.setCount || 3;
        const winThreshold = Math.ceil(setCount / 2);
        
        if(scoringMethod === 'score_set' || scoringMethod === 'win_set') { 
            const maxScore = Math.max(...teams.map(tk => scores[tk] || 0));
            // ถ้ามีทีมที่ชนะเกินครึ่งหนึ่งของจำนวนเซต แสดงว่าจบเกมได้เลย
            if (maxScore >= winThreshold) {
                warningText = `มีทีมชนะ ${winThreshold} ใน ${setCount} เซตแล้ว ยืนยันจบการแข่งขัน?`; 
            }
        } 
        else if(scoringMethod === 'win_once') { 
            warningText = "ยืนยันผลการตัดสิน?"; 
        }
        
        Swal.fire({ 
            title: 'ยืนยันจบการแข่งขัน', 
            text: warningText, 
            icon: 'question', 
            showCancelButton: true, 
            confirmButtonColor: '#198754', 
            confirmButtonText: 'ยืนยัน', 
            cancelButtonText: 'ตรวจสอบก่อน' 
        }).then((result) => {
            if (result.isConfirmed) {
                // หาผู้ชนะ
                let maxScore = 0;
                let winner = 'none';
                let isDraw = false;
                
                teams.forEach(tk => {
                    const score = scores[tk] || 0;
                    if (score > maxScore) {
                        maxScore = score;
                        winner = tk;
                        isDraw = false;
                    } else if (score === maxScore && maxScore > 0) {
                        isDraw = true;
                    }
                });
                
                if (isDraw) winner = 'draw';
                
                // บันทึกสถานะจบและผู้ชนะทันที
                update(ref(db, `matches/${currentMatchId}`), { 
                    status: 'done', 
                    winner: winner
                }).then(() => showPage('dashboard'));
            }
        });
    };
// ===== ฟังก์ชันสร้างหัวเอกสารพร้อมโลโก้คู่ (แก้ปัญหาที่ 1: เพิ่มพารามิเตอร์สีตัวอักษร) =====
    function getDocumentHeader(title, subtitle = '', textColor = '#1a237e') {
        const hasEventLogo = systemSettings.eventLogo && systemSettings.eventLogo.trim() !== '';
        let logoHtml = '';
        
        if (hasEventLogo) {
            logoHtml = `
                <div style="display:flex; justify-content:center; align-items:center; gap:30px; margin-bottom:10px;">
                    <img src="${systemSettings.schoolLogo}" style="height:65px; object-fit:contain;">
                    <img src="${systemSettings.eventLogo}" style="height:65px; object-fit:contain;">
                </div>
            `;
        } else {
            logoHtml = `<img src="${systemSettings.schoolLogo}" style="height:65px; margin-bottom:8px;">`;
        }
        
        let subtitleHtml = subtitle ? `<h3 style="margin:3px 0 0; font-family:'Kanit',sans-serif; font-size:15pt; color:#ff9800;">"${subtitle}"</h3>` : '';
        
        return `
            <div style="text-align:center; margin-bottom:15px; padding-bottom:15px; border-bottom:3px double ${textColor === '#ffffff' ? '#ffffff' : '#1a237e'};">
                ${logoHtml}
                <h2 style="margin:0; font-family:'Kanit',sans-serif; font-size:18pt; color:${textColor};">${title}</h2>
                ${subtitleHtml}
            </div>
        `;
    }

    // ===== รายงานผลแต่ละรายการ =====
    window.previewReport = (id) => {
        onValue(ref(db, 'matches/'+id), (snap) => {
            const m = snap.val();
            if(!m) { Swal.fire('Error', 'ไม่พบข้อมูล', 'error'); return; }
            
            const teams = m.teams || ['team1', 'team2'];
            const scores = m.scores || {};
            
            // สร้างตารางคะแนน
            let scoreTableHtml = '<table style="width:100%; color:#fff;"><tr>';
            teams.forEach(tk => {
                const team = getTeamByKey(tk);
                const score = scores[tk] || 0;
                const colWidth = Math.floor(100 / teams.length);
                
                scoreTableHtml += `
                    <td style="width:${colWidth}%; text-align:center;">
                        <h3 style="margin:0; color:${team.color}; font-size:16pt;">${team.name}</h3>
                        <div style="font-size:50pt; font-weight:bold;">${score}</div>
                    </td>
                `;
            });
            scoreTableHtml += '</tr></table>';
            
            // หาผู้ชนะ
            let maxScore = 0;
            let winnerKey = null;
            let isDraw = false;
            
            teams.forEach(tk => {
                const score = scores[tk] || 0;
                if (score > maxScore) {
                    maxScore = score;
                    winnerKey = tk;
                    isDraw = false;
                } else if (score === maxScore && maxScore > 0) {
                    isDraw = true;
                }
            });
            
            let winnerText = 'ยังไม่มีผู้ชนะ';
            let winnerBg = '#f5f5f5';
            let winnerBorder = '#999';
            
            if (isDraw) {
                winnerText = 'เสมอกัน';
                winnerBg = '#fff9c4';
                winnerBorder = '#fbc02d';
            } else if (winnerKey) {
                const winTeam = getTeamByKey(winnerKey);
                winnerText = `ทีม${winTeam.name}`;
                winnerBg = winTeam.color + '20';
                winnerBorder = winTeam.color;
            }
            
            let html = `
                <div style="text-align:center; margin-bottom:15px; padding-bottom:10px; border-bottom:3px double #1a237e;">
                    ${getDocumentHeader('รายงานผลการแข่งขัน', `${systemSettings.eventName} ${systemSettings.academicYear}`)}
                </div>
                
                <div style="background:#f5f5f5; padding:12px; border-radius:8px; margin-bottom:15px;">
                    <table style="width:100%; font-size:11pt;">
                        <tr>
                            <td><strong>กีฬา:</strong> ${getSportName(m.sport)}</td>
                            <td style="text-align:right;"><strong>วันที่:</strong> ${formatDateThaiLong(m.date)}</td>
                        </tr>
                        <tr>
                            <td><strong>รุ่น:</strong> ${m.category}</td>
                            <td style="text-align:right;"><strong>สนาม:</strong> ${m.location || '-'}</td>
                        </tr>
                    </table>
                </div>
                
                <div style="text-align:center; padding:25px 0; background:linear-gradient(135deg,#1a237e,#3949ab); border-radius:12px; margin-bottom:15px;">
                    ${scoreTableHtml}
                </div>
                
                <div style="background:${winnerBg}; padding:15px; border-radius:8px; text-align:center; margin-bottom:15px; border:3px solid ${winnerBorder};">
                    <h3 style="margin:0; font-family:'Kanit',sans-serif; font-size:16pt;">
                        🏆 ผู้ชนะ: <strong>${winnerText}</strong>
                    </h3>
                </div>
                
                ${m.note ? `<div style="margin-bottom:15px;">
                    <strong>หมายเหตุ:</strong>
                    <div style="padding:8px; border:1px solid #ddd; border-radius:4px; margin-top:5px;">${m.note}</div>
                </div>` : ''}
                
                <div style="margin-top:40px;">
                    <table style="width:100%;">
                        <tr>
                            ${(m.referees||['']).map((r,i) => r ? `
                                <td style="text-align:center;">
                                    <div style="border-bottom:1px dotted #000; width:100px; margin:0 auto 5px;"></div>
                                    <small style="font-size:9pt;">(${r})<br>กรรมการ ${i+1}</small>
                                </td>
                            ` : '').join('')}
                            <td style="text-align:center;">
                                <div style="border-bottom:1px dotted #000; width:100px; margin:0 auto 5px;"></div>
                                <small style="font-size:9pt;">(${m.athleteSign||'................'})<br>${m.sport==='cheer'?'ประธานสี':'ตัวแทนนักกีฬา'}</small>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="text-align:center; font-size:7pt; margin-top:25px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                    พิมพ์จากระบบจัดการกีฬาภายใน | พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง
                </div>
            `;
            
            document.getElementById('reportContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('reportModal')).show();
        }, { onlyOnce: true });
    };

    // ===== สรุปผลการแข่งขัน (แก้ไขปัญหาที่ 1: สี Header) =====
    window.previewSummaryReport = () => {
        if(!allMatchesArray || allMatchesArray.length === 0) { 
            Swal.fire({ icon: 'info', title: 'ไม่พบข้อมูล', text: 'ยังไม่มีรายการแข่งขัน' }); 
            return; 
        }
        
        const activeTeams = getActiveTeams();
        const teamWins = {};
        activeTeams.forEach(team => teamWins[team.key] = 0);
        
        let draw = 0, pending = 0;
        
        allMatchesArray.forEach(m => { 
            if(m.status === 'done') { 
                if(m.winner === 'draw') {
                    draw++;
                } else if (teamWins.hasOwnProperty(m.winner)) {
                    teamWins[m.winner]++;
                }
            } else { 
                pending++; 
            } 
        });
        
        // สร้างตารางสรุปคะแนนแต่ละทีม
        let summaryCardsHtml = '<div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">';
        
        activeTeams.forEach(team => {
            const wins = teamWins[team.key] || 0;
            summaryCardsHtml += `
                <div style="flex:1; min-width:120px; background:linear-gradient(135deg,${team.color}20,${team.color}40); 
                            padding:10px; border-radius:8px; text-align:center; border:2px solid ${team.color};">
                    <div style="font-size:24pt; font-weight:bold; color:${team.color};">${wins}</div>
                    <div style="font-size:9pt; font-weight:600;">🥇 ${team.name}ชนะ</div>
                </div>
            `;
        });
        
        summaryCardsHtml += `
            <div style="flex:1; min-width:120px; background:#f5f5f5; padding:10px; border-radius:8px; text-align:center; border:2px solid #9e9e9e;">
                <div style="font-size:24pt; font-weight:bold; color:#616161;">${draw}</div>
                <div style="font-size:9pt; font-weight:600;">🤝 เสมอ</div>
            </div>
            <div style="flex:1; min-width:120px; background:#fff3e0; padding:10px; border-radius:8px; text-align:center; border:2px solid #ff9800;">
                <div style="font-size:24pt; font-weight:bold; color:#e65100;">${pending}</div>
                <div style="font-size:9pt; font-weight:600;">⏳ รอแข่ง</div>
            </div>
        </div>`;
        
        // ตารางรายการแข่งขัน
        let tableRows = allMatchesArray.map((m, idx) => {
            const teams = m.teams || [];
            const scores = m.scores || {};
            
            let rowBg = '#fff';
            if (m.status === 'done') {
                if (m.winner === 'draw') {
                    rowBg = '#fff9c4';
                } else {
                    const winTeam = getTeamByKey(m.winner);
                    rowBg = winTeam.color + '15';
                }
            }
            
            const statusTxt = m.status === 'done' ? '✅' : '⏳';
            
            let winnerTxt = '-';
            if (m.status === 'done') {
                if (m.winner === 'draw') {
                    winnerTxt = '🤝';
                } else {
                    const winTeam = getTeamByKey(m.winner);
                    winnerTxt = `<span style="color:${winTeam.color};">●</span>`;
                }
            }
            
            const scoreText = teams.map(tk => scores[tk] || 0).join(' - ');
            
            return `
                <tr style="background:${rowBg};">
                    <td style="border:1px solid #333; padding:4px; text-align:center;">${idx+1}</td>
                    <td style="border:1px solid #333; padding:4px; text-align:left; font-size:9pt;">${getSportName(m.sport)}</td>
                    <td style="border:1px solid #333; padding:4px; text-align:center; font-size:9pt;">${m.category || '-'}</td>
                    <td style="border:1px solid #333; padding:4px; text-align:center; font-size:9pt;">${formatDateThai(m.date)}</td>
                    <td style="border:1px solid #333; padding:4px; text-align:center; font-weight:bold;">${scoreText}</td>
                    <td style="border:1px solid #333; padding:4px; text-align:center;">${winnerTxt}</td>
                    <td style="border:1px solid #333; padding:4px; text-align:center;">${statusTxt}</td>
                </tr>
            `;
        }).join('');
        
        // หาทีมที่นำ
        let maxWins = 0;
        let leadingTeams = [];
        
        activeTeams.forEach(team => {
            const wins = teamWins[team.key] || 0;
            if (wins > maxWins) {
                maxWins = wins;
                leadingTeams = [team];
            } else if (wins === maxWins && wins > 0) {
                leadingTeams.push(team);
            }
        });
        
        let overallWinnerText = 'ยังไม่มีผู้นำ';
        let overallBg = '#f5f5f5';
        let overallBorder = '#999';
        
        if (leadingTeams.length === 1) {
            overallWinnerText = `${leadingTeams[0].name}นำ!`;
            overallBg = leadingTeams[0].color + '20';
            overallBorder = leadingTeams[0].color;
        } else if (leadingTeams.length > 1) {
            overallWinnerText = leadingTeams.map(t => t.name).join(' และ ') + ' เสมอกัน!';
            overallBg = '#fff9c4';
            overallBorder = '#fbc02d';
        }
        
        const html = `
            <div style="line-height: 1.6; font-size: 16pt; font-family: 'Kanit', sans-serif;">
                <div style="text-align:center; margin-bottom:12px; padding:12px; background:linear-gradient(135deg,#1a237e,#3949ab); border-radius:10px; color:#fff;">
                    ${getDocumentHeader('🏆 ตารางสรุปผลการแข่งขัน', `${systemSettings.eventName} ${systemSettings.academicYear}`, '#ffffff')}
                </div>
                
                ${summaryCardsHtml}
                
                <table style="width:100%; border-collapse:collapse; font-size:8pt; margin-bottom:15px;">
                    <thead>
                        <tr>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:4%;">#</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:20%; text-align:left;">กีฬา</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:14%;">รุ่น</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:14%;">วันที่</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:15%;">คะแนน</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:10%;">ชนะ</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:5px; width:6%;">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                
                <div style="page-break-inside: avoid;">
                    <div style="margin-top:15px; padding:10px; background:${overallBg}; border-radius:8px; text-align:center; border:3px solid ${overallBorder};">
                        <h3 style="margin:0; font-family:'Kanit',sans-serif; font-size:13pt;">🎊 ${overallWinnerText}</h3>
                        <p style="margin:3px 0 0; font-size:10pt;">
                            ${activeTeams.map(t => `${t.name}: ${teamWins[t.key]}`).join(' | ')} | เสมอ: ${draw} | รอแข่ง: ${pending}
                        </p>
                    </div>
                    
                    <div style="text-align:center; font-size:7pt; margin-top:15px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                        พิมพ์จากระบบจัดการกีฬาภายใน | พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง | พิมพ์เมื่อ ${new Date().toLocaleString('th-TH')}
                    </div>
                </div>
            </div>
        `;
        
        document.getElementById('summaryContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('summaryModal')).show();
    };

    // ===== เตรียม Modal กำหนดการ PDF =====
    window.prepareSchedulePDF = () => {
        const dateSelect = document.getElementById('scheduleDateSelect');
        dateSelect.innerHTML = '<option value="all">ทุกวัน (รวมทั้งหมด)</option>';
        const dates = [...new Set(allMatchesArray.map(m => m.date))].sort();
        dates.forEach(d => {
            dateSelect.innerHTML += `<option value="${d}">${formatDateThaiLong(d)}</option>`;
        });
        
        const sportSelect = document.getElementById('scheduleSportSelect');
        sportSelect.innerHTML = '<option value="all">ทุกกีฬา</option>';
        Object.entries(systemSettings.sports).forEach(([key, name]) => {
            sportSelect.innerHTML += `<option value="${key}">${name}</option>`;
        });
        
        new bootstrap.Modal(document.getElementById('schedulePDFModal')).show();
    };

    // ===== สร้างกำหนดการ PDF =====
    window.generateSchedulePDF = () => {
        const filterDate = document.getElementById('scheduleDateSelect').value;
        const filterSport = document.getElementById('scheduleSportSelect').value;
        const filterStatus = document.getElementById('scheduleStatusSelect').value;
        const format = document.getElementById('scheduleFormatSelect').value;
        
        let filteredMatches = [...allMatchesArray];
        
        if (filterDate !== 'all') filteredMatches = filteredMatches.filter(m => m.date === filterDate);
        if (filterSport !== 'all') filteredMatches = filteredMatches.filter(m => m.sport === filterSport);
        if (filterStatus !== 'all') filteredMatches = filteredMatches.filter(m => m.status === filterStatus);
        
        if (filteredMatches.length === 0) {
            Swal.fire({ icon: 'info', title: 'ไม่พบข้อมูล', text: 'ไม่มีรายการที่ตรงกับเงื่อนไขที่เลือก' });
            return;
        }
        
        filteredMatches.sort((a, b) => {
            if (a.date !== b.date) return a.date.localeCompare(b.date);
            return a.time.localeCompare(b.time);
        });
        
        let dateTitle = filterDate === 'all' ? '' : ` วันที่ ${formatDateThaiLong(filterDate)}`;
        let sportTitle = filterSport === 'all' ? '' : ` - ${getSportName(filterSport)}`;
        
        let html = `
            <div style="text-align:center; margin-bottom:15px; padding-bottom:10px; border-bottom:3px double #1a237e;">
                ${getDocumentHeader(`กำหนดการแข่งขัน${sportTitle}`, `${systemSettings.eventName} ${systemSettings.academicYear}${dateTitle}`)}
            </div>
        `;
        
        const activeTeams = getActiveTeams();
        const teamHeaders = activeTeams.map(t => 
            `<th style="background:${t.color}; color:#fff; border:1px solid #333; padding:6px; width:${Math.floor(20/activeTeams.length)}%;">${t.name}</th>`
        ).join('');
        
        if (format === 'table') {
            html += `
                <table class="schedule-table" style="width:100%; border-collapse:collapse; font-size:10pt;">
                    <thead>
                        <tr>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:5%;">#</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:12%;">วันที่</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:8%;">เวลา</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:20%;">กีฬา</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:15%;">รุ่น/ประเภท</th>
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:12%;">สถานที่</th>
                            ${teamHeaders}
                            <th style="background:#1a237e; color:#fff; border:1px solid #333; padding:6px; width:8%;">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            filteredMatches.forEach((m, idx) => {
                const statusTxt = m.status === 'done' ? '✅ จบ' : '⏳ รอ';
                const rowBg = idx % 2 === 0 ? '#fff' : '#f9f9f9';
                
                let teamScores = '';
                activeTeams.forEach(t => {
                    const score = m.status === 'done' ? (m.scores?.[t.key] || 0) : '-';
                    teamScores += `<td style="border:1px solid #333; padding:5px; text-align:center; font-weight:bold;">${score}</td>`;
                });
                
                html += `
                    <tr style="background:${rowBg};">
                        <td style="border:1px solid #333; padding:5px; text-align:center;">${idx + 1}</td>
                        <td style="border:1px solid #333; padding:5px; text-align:center;">${formatDateThai(m.date)}</td>
                        <td style="border:1px solid #333; padding:5px; text-align:center;">${m.time}</td>
                        <td style="border:1px solid #333; padding:5px; text-align:left;">${getSportName(m.sport)}</td>
                        <td style="border:1px solid #333; padding:5px; text-align:center;">${m.category}</td>
                        <td style="border:1px solid #333; padding:5px; text-align:center;">${m.location || '-'}</td>
                        ${teamScores}
                        <td style="border:1px solid #333; padding:5px; text-align:center;">${statusTxt}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            
        } else {
            const groupedByDate = {};
            filteredMatches.forEach(m => {
                if (!groupedByDate[m.date]) groupedByDate[m.date] = [];
                groupedByDate[m.date].push(m);
            });
            
            Object.keys(groupedByDate).sort().forEach(date => {
                html += `
                    <div style="background:#1a237e; color:#fff; padding:8px 15px; margin:15px 0 10px; border-radius:5px;">
                        <strong>📅 ${formatDateThaiLong(date)}</strong>
                    </div>
                `;
                
                groupedByDate[date].forEach((m, idx) => {
                    const statusIcon = m.status === 'done' ? '✅' : '⏰';
                    const teams = m.teams || [];
                    const scores = m.scores || {};
                    let scoreTxt = 'รอแข่งขัน';
                    
                    if (m.status === 'done') {
                        scoreTxt = teams.map(tk => {
                            const team = getTeamByKey(tk);
                            return `${team.name}: ${scores[tk]||0}`;
                        }).join(' | ');
                    }
                    
                    html += `
                        <div style="display:flex; padding:8px 10px; border-bottom:1px solid #eee; align-items:center;">
                            <div style="width:60px; font-weight:bold; color:#1a237e;">${m.time}</div>
                            <div style="flex:1;">
                                <strong>${getSportName(m.sport)}</strong>
                                <span style="color:#666; font-size:0.9em;"> - ${m.category}</span>
                                <div style="font-size:0.85em; color:#888;">📍 ${m.location || 'ไม่ระบุสถานที่'}</div>
                            </div>
                            <div style="text-align:right; min-width:150px;">
                                <span style="font-size:0.85em;">${statusIcon} ${scoreTxt}</span>
                            </div>
                        </div>
                    `;
                });
            });
        }
        
        html += `
            <div style="text-align:center; font-size:8pt; margin-top:20px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                พิมพ์จากระบบจัดการกีฬาภายใน | พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง | พิมพ์เมื่อ ${new Date().toLocaleString('th-TH')}
            </div>
        `;
        
        document.getElementById('scheduleContent').innerHTML = html;
        bootstrap.Modal.getInstance(document.getElementById('schedulePDFModal')).hide();
        new bootstrap.Modal(document.getElementById('schedulePreviewModal')).show();
    };

    // ===== พิมพ์รายชื่อนักกีฬา =====
    window.previewPlayerList = () => {
        const m = matchDataLocal;
        const teams = m.teams || [];
        
        let html = `
            <div style="text-align:center; margin-bottom:15px; padding-bottom:10px; border-bottom:3px double #1a237e;">
                ${getDocumentHeader('ใบรายชื่อนักกีฬา', `${systemSettings.eventName} ${systemSettings.academicYear}`)}
            </div>
            
            <div style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:15px;">
                <table style="width:100%; font-size:11pt;">
                    <tr>
                        <td><strong>กีฬา:</strong> ${getSportName(m.sport)}</td>
                        <td style="text-align:right;"><strong>วันที่:</strong> ${formatDateThaiLong(m.date)}</td>
                    </tr>
                    <tr>
                        <td><strong>รุ่น:</strong> ${m.category}</td>
                        <td style="text-align:right;"><strong>สนาม:</strong> ${m.location || '-'}</td>
                    </tr>
                </table>
            </div>
            
            <div style="display:flex; gap:15px; flex-wrap:wrap;">
        `;
        
        teams.forEach(tk => {
            const team = getTeamByKey(tk);
            const players = m.players?.[tk] || [];
            
            let playersHtml = players.filter(p => p).map((p, i) => `
                <tr>
                    <td style="border:1px solid #ddd; padding:5px; text-align:center;">${i+1}</td>
                    <td style="border:1px solid #ddd; padding:5px;">${p}</td>
                    <td style="border:1px solid #ddd; padding:5px;"></td>
                </tr>
            `).join('') || '<tr><td colspan="3" style="text-align:center; padding:20px; color:#999;">ไม่มีรายชื่อ</td></tr>';
            
            html += `
                <div style="flex:1; min-width:250px;">
                    <h4 style="background:${team.color}; color:#fff; padding:8px; border-radius:5px; text-align:center; margin-bottom:10px;">
                        ${team.name}
                    </h4>
                    <table style="width:100%; border-collapse:collapse; font-size:10pt;">
                        <thead>
                            <tr>
                                <th style="background:${team.color}30; border:1px solid #ddd; padding:5px; width:10%;">#</th>
                                <th style="background:${team.color}30; border:1px solid #ddd; padding:5px;">ชื่อ-สกุล</th>
                                <th style="background:${team.color}30; border:1px solid #ddd; padding:5px; width:20%;">ลายเซ็น</th>
                            </tr>
                        </thead>
                        <tbody>${playersHtml}</tbody>
                    </table>
                </div>
            `;
        });
        
        html += `
            </div>
            <div style="text-align:center; font-size:7pt; margin-top:25px; color:#999; border-top:1px solid #eee; padding-top:10px;">
                พิมพ์จากระบบจัดการกีฬาภายใน | พัฒนาโดย ครูนนทพัทธ์ หิรัญเรือง
            </div>
        `;
        
        document.getElementById('playerListContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('playerListModal')).show();
    };

    // ===== Copy Text Functions =====
    window.previewCopy = (type) => {
        const filterD = document.getElementById('filterDate').value;
        let text = "";
        let targetMatches = allMatchesArray;
        let dateLabel = "ทั้งหมด";

        if (filterD !== 'all') {
            targetMatches = allMatchesArray.filter(m => m.date === filterD);
            dateLabel = `วันที่ ${formatDateThai(filterD)}`;
        }

        if (targetMatches.length === 0) {
            Swal.fire({ icon: 'info', title: 'ไม่พบข้อมูล', text: 'ไม่มีรายการแข่งขันในช่วงเวลาที่เลือก' });
            return;
        }

        const eventTag = `#${systemSettings.eventName.replace(/\s+/g, '')}${systemSettings.academicYear}`;

        if (type === 'schedule') {
            document.getElementById('previewTitle').innerHTML = '<i class="far fa-calendar-alt me-2"></i> ตัวอย่างกำหนดการ';
            text = `📅 กำหนดการแข่งขันกีฬาภายใน\n📍 ประจำ${dateLabel}\n----------------------------\n`;
            targetMatches.forEach(m => {
                let statusIcon = m.status === 'done' ? '✅' : '⏰';
                text += `${statusIcon} ${m.time} น. : ${getSportName(m.sport)}\n   👉 ${m.category} (สนาม: ${m.location||'-'})\n\n`;
            });
        } else if (type === 'result') {
            document.getElementById('previewTitle').innerHTML = '<i class="fas fa-trophy me-2"></i> ตัวอย่างผลการแข่งขัน';
            text = `📢 สรุปผลการแข่งขันกีฬาภายใน\n📍 ประจำ${dateLabel}\n----------------------------\n`;
            let hasResult = false;
            targetMatches.forEach(m => {
                if(m.status === 'done') {
                    hasResult = true;
                    const teams = m.teams || [];
                    const scores = m.scores || {};
                    let scoreText = teams.map(tk => {
                        const team = getTeamByKey(tk);
                        return `${team.name} ${scores[tk]||0}`;
                    }).join(' - ');
                    text += `✅ ${getSportName(m.sport)} (${m.category})\n   ${scoreText}\n\n`;
                }
            });
            if(!hasResult) text += "(ยังไม่มีการบันทึกผลการแข่งขัน)\n";
            
            if (filterD === 'all') {
                const activeTeams = getActiveTeams();
                text += `----------------------------\n📊 สรุปเหรียญรวม (ทั้งหมด)\n`;
                activeTeams.forEach(team => {
                    let wins = 0;
                    allMatchesArray.forEach(m => { 
                        if(m.status === 'done' && m.winner === team.key) wins++; 
                    });
                    text += `🥇 ${team.name}: ${wins} เหรียญ\n`;
                });
            }
        }

        text += `----------------------------\n${eventTag}`;
        document.getElementById('copyPreviewText').value = text;
        new bootstrap.Modal(document.getElementById('copyPreviewModal')).show();
    };

    window.copyFromPreview = () => {
        const copyText = document.getElementById("copyPreviewText");
        copyText.select();
        copyText.setSelectionRange(0, 99999); 
        navigator.clipboard.writeText(copyText.value).then(() => {
            Swal.fire({ icon: 'success', title: 'คัดลอกแล้ว', timer: 1000, showConfirmButton: false });
            bootstrap.Modal.getInstance(document.getElementById('copyPreviewModal')).hide();
        });
    };

    window.copyMatchText = (id, type) => {
        const m = allMatchesArray.find(x => x.id === id);
        if(!m) return;
        const eventTag = `#${systemSettings.eventName.replace(/\s+/g, '')}${systemSettings.academicYear}`;
        let text = "";
        
        if(type === 'schedule') { 
            text = `📅 กำหนดการแข่งขัน\n🏆 กีฬา: ${getSportName(m.sport)} (${m.category})\n⏰ เวลา: ${m.time} น. (วันที่ ${formatDateThai(m.date)})\n📍 สนาม: ${m.location || '-'}\n\n${eventTag}`; 
        } else {
            const teams = m.teams || [];
            const scores = m.scores || {};
            let scoreText = 'ยังไม่แข่ง';
            if (m.status === 'done') {
                scoreText = teams.map(tk => {
                    const team = getTeamByKey(tk);
                    return `${team.name} ${scores[tk]||0}`;
                }).join(' - ');
            }
            text = `📢 ผลการแข่งขัน\n🏆 กีฬา: ${getSportName(m.sport)} (${m.category})\n------------------\n${scoreText}\n------------------\n${eventTag}`; 
        }
        navigator.clipboard.writeText(text).then(() => { 
            Swal.fire({ icon: 'success', title: 'คัดลอกข้อความแล้ว', timer: 1000, showConfirmButton: false }); 
        });
    };

    // ===== ส่งออก/นำเข้า/ล้างข้อมูล =====
    window.exportToExcel = () => {
        if (allMatchesArray.length === 0) {
            Swal.fire({ icon: 'info', title: 'ไม่มีข้อมูล', text: 'ยังไม่มีรายการแข่งขันในระบบ' });
            return;
        }
        const activeTeams = getActiveTeams();
        const exportData = allMatchesArray.map((m, idx) => {
            const teams = m.teams || [];
            const scores = m.scores || {};
            const players = m.players || {};
            const teamScores = {};
            activeTeams.forEach(team => { teamScores[`คะแนน_${team.name}`] = scores[team.key] || 0; });
            const teamPlayers = {};
            activeTeams.forEach(team => { 
                const pList = players[team.key] || [];
                teamPlayers[`นักกีฬา_${team.name}`] = pList.filter(p => p).join(', ');
            });
            let winnerText = '-';
            if (m.status === 'done') {
                if (m.winner === 'draw') winnerText = 'เสมอ';
                else { const winTeam = getTeamByKey(m.winner); winnerText = winTeam.name; }
            }
            return {
                'ลำดับ': idx + 1, 'รหัสกีฬา': m.sport, 'ชื่อกีฬา': getSportName(m.sport), 'รุ่น/ประเภท': m.category,
                'วันที่': m.date, 'เวลา': m.time, 'สถานที่': m.location || '', 'วิธีตัดสิน': m.scoringMethod || 'score_once',
                'จำนวน Set': m.setCount || '', ...teamScores, 'ผู้ชนะ': winnerText, 'สถานะ': m.status === 'done' ? 'จบแล้ว' : 'รอแข่ง',
                'กรรมการ': (m.referees || []).filter(r => r).join(', '), 'ลงชื่อนักกีฬา': m.athleteSign || '', 'หมายเหตุ': m.note || '',
                ...teamPlayers, 'ทีมที่แข่งขัน': (m.teams || []).join(','), 'รายละเอียดคะแนน': JSON.stringify(m.details || {}), 'Firebase ID': m.id
            };
        });

        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);
        XLSX.utils.book_append_sheet(wb, ws, 'รายการแข่งขัน');
        
        const settingsData = [
            { 'รายการ': 'ชื่อโรงเรียน', 'ค่า': systemSettings.schoolName },
            { 'รายการ': 'ชื่อกิจกรรม', 'ค่า': systemSettings.eventName },
            { 'รายการ': 'ปีการศึกษา', 'ค่า': systemSettings.academicYear },
            { 'รายการ': 'รายการกีฬา', 'ค่า': JSON.stringify(systemSettings.sports) },
            { 'รายการ': 'ข้อมูลทีม', 'ค่า': JSON.stringify(systemSettings.teams) }
        ];
        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(settingsData), 'การตั้งค่า');
        
        const fileName = `${systemSettings.eventName}_${systemSettings.academicYear}_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, fileName);
        Swal.fire({ icon: 'success', title: 'ส่งออกข้อมูลสำเร็จ', text: `บันทึกไฟล์ ${fileName}`, timer: 2000, showConfirmButton: false });
    };

    window.triggerImportExcel = () => { document.getElementById('importExcelInput').click(); };

    window.importFromExcel = async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        
        const result = await Swal.fire({
            title: 'ยืนยันการนำเข้าข้อมูล',
            html: `<p>คุณกำลังจะนำเข้าข้อมูลจากไฟล์:</p><strong>${file.name}</strong><br><br><p class="text-danger">⚠️ ข้อมูลเดิมจะถูกแทนที่ด้วยข้อมูลใหม่</p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'นำเข้าข้อมูล',
            cancelButtonText: 'ยกเลิก'
        });

        if (!result.isConfirmed) { event.target.value = ''; return; }

        try {
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const matchSheet = workbook.Sheets['รายการแข่งขัน'];
            if (!matchSheet) throw new Error('ไม่พบ Sheet "รายการแข่งขัน" ในไฟล์');
            
            const matchData = XLSX.utils.sheet_to_json(matchSheet);
            if (matchData.length === 0) throw new Error('ไม่พบข้อมูลรายการแข่งขันในไฟล์');

            Swal.fire({ title: 'กำลังนำเข้าข้อมูล...', html: `<p>กรุณารอสักครู่</p>`, allowOutsideClick: false, didOpen: () => { Swal.showLoading(); } });
            
            await remove(ref(db, 'matches'));
            
            const activeTeams = getActiveTeams();
            let imported = 0;
            
            for (const row of matchData) {
                const scores = {};
                const players = {};
                activeTeams.forEach(team => {
                    if (row[`คะแนน_${team.name}`] !== undefined) scores[team.key] = parseInt(row[`คะแนน_${team.name}`]) || 0;
                    if (row[`นักกีฬา_${team.name}`]) players[team.key] = row[`นักกีฬา_${team.name}`].split(', ').filter(p => p);
                    else players[team.key] = [];
                });
                
                let winner = 'none';
                if (row['สถานะ'] === 'จบแล้ว') {
                    if (row['ผู้ชนะ'] === 'เสมอ') winner = 'draw';
                    else {
                        const winTeam = activeTeams.find(t => t.name === row['ผู้ชนะ']);
                        if (winTeam) winner = winTeam.key;
                    }
                }
                
                const teams = row['ทีมที่แข่งขัน'] ? row['ทีมที่แข่งขัน'].split(',') : ['team1', 'team2'];
                const newMatch = {
                    sport: row['รหัสกีฬา'] || '', category: row['รุ่น/ประเภท'] || '',
                    date: row['วันที่'] || '', time: row['เวลา'] || '', location: row['สถานที่'] || '',
                    scoringMethod: row['วิธีตัดสิน'] || 'score_once', setCount: parseInt(row['จำนวน Set']) || 3,
                    scores: scores, winner: winner, status: row['สถานะ'] === 'จบแล้ว' ? 'done' : 'wait',
                    referees: row['กรรมการ'] ? row['กรรมการ'].split(', ').filter(r => r) : [''],
                    athleteSign: row['ลงชื่อนักกีฬา'] || '', note: row['หมายเหตุ'] || '',
                    players: players, teams: teams,
                    details: row['รายละเอียดคะแนน'] ? JSON.parse(row['รายละเอียดคะแนน']) : {},
                    createdAt: new Date().toISOString()
                };
                await push(ref(db, 'matches'), newMatch);
                imported++;
            }
            
            event.target.value = '';
            Swal.fire({ icon: 'success', title: 'นำเข้าข้อมูลสำเร็จ', text: `นำเข้าทั้งหมด ${imported} รายการ`, timer: 2000, showConfirmButton: false });
        } catch (error) {
            console.error('Import Error:', error);
            event.target.value = '';
            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message || 'ไม่สามารถนำเข้าข้อมูลได้' });
        }
    };

    window.resetAllData = async () => {
        const result1 = await Swal.fire({
            title: '⚠️ ยืนยันการล้างข้อมูล',
            html: `<p>คุณกำลังจะ<strong class="text-danger">ลบข้อมูลการแข่งขันทั้งหมด</strong></p><p class="text-danger fw-bold">การกระทำนี้ไม่สามารถกู้คืนได้!</p>`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'ต้องการล้างข้อมูล',
            cancelButtonText: 'ยกเลิก'
        });

        if (!result1.isConfirmed) return;

        const { value: pass } = await Swal.fire({
            title: 'ใส่รหัสผ่านเพื่อยืนยัน',
            input: 'password',
            inputPlaceholder: 'รหัสผ่าน...',
            showCancelButton: true,
            confirmButtonText: 'ยืนยันล้างข้อมูล',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#d33'
        });

        if (pass !== systemSettings.password) {
            if (pass) Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง' });
            return;
        }

        const result2 = await Swal.fire({
            title: 'ยืนยันครั้งสุดท้าย',
            text: `พิมพ์ "ลบข้อมูล" เพื่อยืนยัน`,
            input: 'text',
            inputPlaceholder: 'พิมพ์ "ลบข้อมูล"',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            confirmButtonText: 'ล้างข้อมูลทันที',
            cancelButtonText: 'ยกเลิก',
            inputValidator: (value) => { if (value !== 'ลบข้อมูล') return 'กรุณาพิมพ์ "ลบข้อมูล" ให้ถูกต้อง'; }
        });

        if (!result2.isConfirmed) return;

        try {
            await remove(ref(db, 'matches'));
            Swal.fire({ icon: 'success', title: 'ล้างข้อมูลเรียบร้อย', text: 'ระบบพร้อมสำหรับปีการศึกษาใหม่', timer: 2000, showConfirmButton: false });
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
        }
    };
</script>
</body>
</html>
