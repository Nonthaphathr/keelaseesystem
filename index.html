<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75, maximum-scale=1.5, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>ระบบบันทึกผลการแข่งขัน - กีฬาสี 2568</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        * {
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(rgba(240, 242, 245, 0.85), rgba(240, 242, 245, 0.85)), 
                        url('https://nonthaphathr.github.io/uploadimg/keelaseebg.png');
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh;
            padding-bottom: 60px;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, .nav-link, .btn, .modal-title { font-family: 'Kanit', sans-serif; }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease;
        }
        .spinner-logo { width: 80px; animation: spin 2s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: var(--glass-shadow);
            margin-bottom: 24px;
            transition: all 0.3s ease;
        }

        .navbar {
            background: rgba(21, 30, 61, 0.98) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        .navbar-brand img { height: 50px; margin-right: 12px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }

        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; }
        .bg-live { background: #dc3545; color: white; animation: pulse 1.5s infinite; }
        .bg-wait { background: #6c757d; color: white; }
        .bg-done { background: #198754; color: white; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .btn-add-match {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 50%, #ffc107 100%);
            background-size: 200% 200%;
            border: none;
            color: #000 !important;
            font-weight: 700;
            font-size: 0.95rem;
            padding: 8px 18px;
            position: relative;
            overflow: hidden;
            animation: gradient-shift 3s ease infinite, btn-glow 2s ease-in-out infinite;
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5);
            transition: all 0.3s ease;
        }
        .btn-add-match::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -100%;
            width: 100%;
            height: 200%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: skewX(-25deg);
            animation: shimmer 2.5s infinite;
        }
        .btn-add-match:hover, .btn-add-match:active {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(255, 193, 7, 0.7);
            color: #000 !important;
        }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 200%; } }
        @keyframes gradient-shift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        @keyframes btn-glow { 0%, 100% { box-shadow: 0 4px 15px rgba(255, 193, 7, 0.5); } 50% { box-shadow: 0 4px 25px rgba(255, 193, 7, 0.9); } }

        /* Page Section Control - FIX สำหรับปัญหาการแสดงผล */
        .page-section {
            display: none !important;
            width: 100%;
        }

        .page-section.active {
            display: block !important;
        }

        /* Team Selection Styles */
        .team-select-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }
        
        .team-select-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .team-select-card.selected {
            border-width: 3px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .team-select-card input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .report-preview-page {
            background: white;
            width: 210mm;
            min-height: auto;
            margin: 10px auto;
            padding: 20mm 25mm;
            color: #000;
            position: relative;
            font-family: 'Kanit', sans-serif;
            box-sizing: border-box;
            line-height: 1.5;
            font-size: 14pt;
        }
        
        .speech-line {
            text-align: justify;
            text-justify: inter-word;
            margin-bottom: 8px;
            line-height: 1.6;
        }
        .speech-indent {
            text-indent: 2.5cm;
        }
        
        #qrImage { max-width: 100%; height: auto; border: 10px solid white; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.2); }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        #matchList td, #matchList th {
            white-space: nowrap;
            padding: 8px 10px;
        }
        
        @media (max-width: 768px) {
            .container { padding-left: 10px; padding-right: 10px; }
            .navbar-brand span.fs-5 { font-size: 1rem !important; }
            .navbar-brand img { height: 40px; }
            .glass-card { padding: 12px !important; border-radius: 12px; }
            .display-5 { font-size: 2rem !important; }
            .btn-sm { font-size: 0.75rem; padding: 5px 10px; }
            .table { font-size: 0.85rem; }
        }
        
        .btn { min-height: 38px; touch-action: manipulation; }
        html { scroll-behavior: smooth; }
        input, select, textarea { font-size: 16px !important; }
        
        .credit-footer {
            text-align: center;
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 2rem;
            margin-bottom: 1rem;
            font-weight: 300;
        }
        
        .setting-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }
        .setting-section h6 {
            color: #1a237e;
            border-bottom: 2px solid #ffc107;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        
        .team-config-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            transition: all 0.3s;
        }
        .team-config-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .team-color-preview {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        #teamManagementModal {
            z-index: 1060 !important;
        }

        #teamManagementModal .modal-backdrop {
            z-index: 1055 !important;
        }
        
        @media print {
            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .report-preview-page {
                margin: 0;
                padding: 20mm 25mm;
                width: 100%;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" class="spinner-logo" id="loadingLogo">
        <h4 class="text-secondary fw-bold">กำลังโหลดข้อมูล...</h4>
        <small class="text-muted" id="loadingEventName">กีฬาสี 2568</small>
        <button class="btn btn-sm btn-outline-secondary mt-3" onclick="forceHideLoader()">กดตรงนี้หากรอนานเกินไป</button>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" alt="Logo" id="navbarLogo">
                <div class="d-flex flex-column ms-2">
                    <span class="fs-5 fw-bold text-warning" id="navbarEventName">กีฬาสี 2568</span>
                    <small class="text-white-50 d-none d-sm-block" style="font-size: 0.75rem;" id="navbarSchoolName">โรงเรียนกระดุมทองวิทยา</small>
                </div>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto gap-2 py-2 py-lg-0">
                    <li class="nav-item"><button class="btn btn-sm btn-outline-light border-0 w-100" onclick="showQRCode()"><i class="fas fa-qrcode me-1"></i> QR ระบบ</button></li>
                    <li class="nav-item">
                        <a href="register.html" target="_blank" class="btn btn-sm btn-outline-warning border-0 w-100 text-start text-lg-center">
                            <i class="fas fa-user-edit me-1"></i> ระบบลงทะเบียน
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="ceremony-docs.html" target="_blank" class="btn btn-sm btn-outline-primary border-0 w-100 text-start text-lg-center">
                            <i class="fas fa-file-invoice me-1"></i> สร้างเอกสารพิธีการ
                        </a>
                    </li>
                    <li class="nav-item"><button class="btn btn-sm btn-outline-info border-0 w-100" onclick="showManual()"><i class="fas fa-book-reader me-1"></i> คู่มือ</button></li>
                    <li class="nav-item"><button class="btn btn-sm btn-outline-success border-0 w-100" onclick="showSettings()"><i class="fas fa-cog me-1"></i> ตั้งค่าระบบ</button></li>
                    <li class="nav-item"><button class="btn btn-sm btn-light w-100" onclick="showPage('dashboard')"><i class="fas fa-home me-1"></i> หน้าหลัก</button></li>
                    <li class="nav-item"><button class="btn btn-sm btn-add-match w-100" onclick="prepareAddMatch()"><i class="fas fa-plus me-1"></i> เพิ่มรายการ</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <!-- ========== DASHBOARD PAGE ========== -->
        <div id="page-dashboard" class="page-section active">
            <div class="row g-2 g-md-3 mb-3 mb-md-4" id="teamSummaryCards"></div>

            <div class="glass-card p-2 p-md-3">
                <div class="d-flex flex-wrap gap-2 mb-3 align-items-center">
                    <span class="fw-bold d-none d-sm-inline"><i class="fas fa-filter"></i> ตัวกรอง:</span>
                    <select id="filterDate" class="form-select form-select-sm" style="width: auto; min-width: 110px;" onchange="applyFilters()">
                        <option value="all">ทุกวัน</option>
                    </select>

                    <select id="filterSport" class="form-select form-select-sm" style="width: auto; min-width: 100px;" onchange="applyFilters()">
                        <option value="all">ทุกกีฬา</option>
                    </select>
                    
                    <select id="filterScoringMethod" class="form-select form-select-sm" style="width: auto; min-width: 120px;" onchange="applyFilters()">
                        <option value="all">ทุกรูปแบบ</option>
                        <option value="score_set">ลงคะแนน Set</option>
                        <option value="win_set">ชนะ/แพ้ Set</option>
                        <option value="score_once">ลงคะแนนรอบเดียว</option>
                        <option value="win_once">ชนะ/แพ้รอบเดียว</option>
                    </select>
                    
                    <select id="filterWinner" class="form-select form-select-sm" style="width: auto; min-width: 90px;" onchange="applyFilters()">
                        <option value="all">ทั้งหมด</option>
                    </select>
                    
                    <div class="ms-auto d-flex gap-2 flex-wrap">
                        <div class="dropdown">
                            <button class="btn btn-sm btn-outline-dark dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-clipboard-list me-1"></i> คัดลอกข้อมูล
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="previewCopy('schedule')"><i class="far fa-calendar-alt me-2"></i>กำหนดการแข่งขัน</a></li>
                                <li><a class="dropdown-item" href="#" onclick="previewCopy('result')"><i class="fas fa-trophy me-2"></i>ผลการแข่งขัน</a></li>
                            </ul>
                        </div>

                        <button class="btn btn-sm btn-primary" onclick="prepareSchedulePDF()"><i class="fas fa-calendar-alt me-1"></i><span class="d-none d-sm-inline">กำหนดการ(PDF)</span></button>
                        <button class="btn btn-sm btn-danger" onclick="previewSummaryReport()"><i class="fas fa-file-pdf me-1"></i><span class="d-none d-sm-inline">สรุปผล(PDF)</span></button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" style="min-width: 500px;">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">เวลา</th>
                                <th style="width: 30%;">รายการ</th>
                                <th class="text-center" style="width: 15%;">คะแนน</th>
                                <th class="text-center" style="width: 15%;">ผู้ชนะ</th>
                                <th class="text-end" style="width: 25%;">จัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="matchList" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========== SETUP PAGE (ปรับปรุงใหม่ - เพิ่มการเลือกทีม) ========== -->
        <div id="page-setup" class="page-section">
            <div class="glass-card p-3 p-md-4 mx-auto" style="max-width: 900px;">
                <h4 class="mb-3 border-bottom pb-2" id="setupTitle"><i class="fas fa-calendar-plus"></i> เพิ่มรายการแข่งขัน</h4>
                <form id="setupForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">ชนิดกีฬา</label>
                            <select class="form-select" id="sportType" required>
                                <option value="" disabled selected>-- เลือก --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">รุ่น/ประเภท</label>
                            <input type="text" class="form-control" id="category" placeholder="เช่น ม.ต้น ชาย, ทีมผสม" required>
                        </div>
                        
                        <!-- ส่วนเลือกทีมที่แข่งขัน (ใหม่) -->
                        <div class="col-12">
                            <label class="form-label small fw-bold">
                                <i class="fas fa-users me-1"></i> เลือกทีมที่เข้าแข่งขัน 
                                <span class="badge bg-info ms-1">อย่างน้อย 2 ทีม</span>
                            </label>
                            <div id="teamSelectionContainer" class="row g-2">
                                <!-- Will be populated dynamically -->
                            </div>
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle"></i> สามารถเลือกได้มากกว่า 2 ทีมสำหรับการแข่งขันหลายรอบ
                            </small>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label small fw-bold">วิธีตัดสิน</label>
                            <select class="form-select" id="scoringMethod" required onchange="toggleSetCount()">
                                <option value="" disabled selected>-- เลือกวิธีตัดสิน --</option>
                                <option value="score_set">ลงคะแนนเป็น Set</option>
                                <option value="win_set">เลือกชนะ/แพ้เป็น Set</option>
                                <option value="score_once">ลงคะแนนรอบเดียว</option>
                                <option value="win_once">เลือกชนะ/แพ้รอบเดียว</option>
                            </select>
                        </div>
                        <div class="col-12 col-md-6 d-none" id="setCountContainer">
                            <label class="form-label small fw-bold">จำนวน Set</label>
                            <select class="form-select" id="setCount">
                                <option value="3">3 Set (Best of 3)</option>
                                <option value="5">5 Set (Best of 5)</option>
                                <option value="7">7 Set (Best of 7)</option>
                            </select>
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">วันที่</label>
                            <input type="date" class="form-control" id="matchDate" required value="2025-12-03">
                        </div>
                        <div class="col-6 col-md-4">
                            <label class="form-label small fw-bold">เวลา</label>
                            <input type="time" class="form-control" id="matchTime" required>
                        </div>
                        <div class="col-12 col-md-4">
                            <label class="form-label small fw-bold">สถานที่</label>
                            <input type="text" class="form-control" id="location" placeholder="เช่น สนาม 1">
                        </div>
                        <div class="col-12 mt-4">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="button" class="btn btn-light" onclick="showPage('dashboard')">ยกเลิก</button>
                                <button type="submit" class="btn btn-primary px-4" id="setupSubmitBtn">บันทึก</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- ========== MATCH PAGE (รองรับ Dynamic Teams) ========== -->
        <div id="page-match" class="page-section">
            <button class="btn btn-sm btn-light mb-3 border shadow-sm" onclick="showPage('dashboard')">
                <i class="fas fa-arrow-left"></i> กลับ
            </button>
            
            <div class="row g-3">
                <div class="col-lg-5">
                    <div class="glass-card p-3 h-100">
                        <ul class="nav nav-tabs mb-3" id="matchTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#tab-info">ข้อมูล</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#tab-players">รายชื่อ</a>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="tab-info">
                                <div id="refereeSection">
                                    <label class="small fw-bold text-muted">กรรมการผู้ตัดสิน</label>
                                    <div id="refereeInputs"></div> 
                                </div>
                                <div class="mt-3">
                                    <label class="small fw-bold text-muted" id="signerLabel">ตัวแทนนักกีฬาผู้ชนะ</label>
                                    <input type="text" class="form-control form-control-sm" id="athleteSign" placeholder="ลงชื่อ...">
                                </div>
                                <div class="mt-3">
                                    <label class="small fw-bold text-muted">หมายเหตุ</label>
                                    <textarea id="matchNote" class="form-control form-control-sm" rows="2"></textarea>
                                </div>
                                <button class="btn btn-primary w-100 mt-3" onclick="saveMatchInfo()">
                                    <i class="fas fa-save me-1"></i> บันทึกข้อมูล
                                </button>
                            </div>

                            <div class="tab-pane fade" id="tab-players">
                                <div id="playersTabContent">
                                    <div class="text-center py-4 text-muted">
                                        <i class="fas fa-users fa-2x mb-2 opacity-50"></i>
                                        <p class="small">กำลังโหลดรายชื่อ...</p>
                                    </div>
                                </div>
                                <button class="btn btn-sm btn-dark w-100 mt-3" onclick="previewPlayerList()">
                                    <i class="fas fa-print me-1"></i> พิมพ์รายชื่อ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="glass-card p-3 p-md-4 text-center">
                        <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
                            <span class="badge bg-secondary" id="matchCatDisplay">Category</span>
                            <span class="status-badge bg-live">LIVE</span>
                            <button class="btn btn-sm btn-outline-danger" onclick="clearMatchData()">
                                <i class="fas fa-redo me-1"></i> ล้าง
                            </button>
                        </div>
                        
                        <h3 class="fw-bold mb-3 mb-md-4" id="matchTitleDisplay" 
                            style="font-size: clamp(1.2rem, 4vw, 1.75rem);">Sport Name</h3>

                        <div id="scoreDisplayArea" class="mb-3 mb-md-4">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-trophy fa-2x mb-2 opacity-50"></i>
                                <p class="small">กำลังโหลดคะแนน...</p>
                            </div>
                        </div>

                        <div id="dynamicScoreControls" class="bg-white rounded p-3 shadow-sm border text-start">
                            <div class="text-center py-4 text-muted">
                                <i class="fas fa-lock fa-2x mb-2 opacity-50"></i>
                                <p class="small">กำลังโหลดระบบลงคะแนน...</p>
                            </div>
                        </div>

                        <button class="btn btn-success w-100 mt-3 mt-md-4 py-2 fs-5 shadow-sm" onclick="finishMatch()">
                            <i class="fas fa-check-circle me-2"></i> จบการแข่งขัน
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="credit-footer">
            พัฒนาระบบโดย ครูนนทพัทธ์ หิรัญเรือง
        </div>

    </div>
    <!-- ========== MODALS ========== -->
    
    <!-- QR Code Modal -->
    <div class="modal fade" id="qrModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">QR Code เข้าระบบ</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body"></div>
            </div>
        </div>
    </div>

    <!-- Copy Preview Modal -->
    <div class="modal fade" id="copyPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title" id="previewTitle">ตัวอย่างข้อความ</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <textarea id="copyPreviewText" class="form-control border-0 p-3" rows="12" style="font-size: 0.9rem; background: #fafafa;"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary" onclick="copyFromPreview()"><i class="fas fa-copy me-1"></i> คัดลอกข้อความ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-file-alt me-2"></i>รายงานผล</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="reportContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('reportContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal fade" id="summaryModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-trophy me-2"></i>สรุปผลการแข่งขัน</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="summaryContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('summaryContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule PDF Modal -->
    <div class="modal fade" id="schedulePDFModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>สร้างกำหนดการแข่งขัน (PDF)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">เลือกวันที่แสดง</label>
                            <select class="form-select" id="scheduleDateSelect">
                                <option value="all">ทุกวัน (รวมทั้งหมด)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">เลือกชนิดกีฬา</label>
                            <select class="form-select" id="scheduleSportSelect">
                                <option value="all">ทุกกีฬา</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">แสดงสถานะ</label>
                            <select class="form-select" id="scheduleStatusSelect">
                                <option value="all">ทั้งหมด</option>
                                <option value="wait">เฉพาะรอแข่ง</option>
                                <option value="done">เฉพาะจบแล้ว</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">รูปแบบเอกสาร</label>
                            <select class="form-select" id="scheduleFormatSelect">
                                <option value="table">ตาราง</option>
                                <option value="list">รายการ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="alert alert-info small mt-3 mb-0">
                        <i class="fas fa-info-circle me-1"></i> เลือกตัวกรองแล้วกด "สร้างเอกสาร" เพื่อดูตัวอย่างและพิมพ์
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-primary" onclick="generateSchedulePDF()"><i class="fas fa-file-pdf me-1"></i> สร้างเอกสาร</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Schedule Preview Modal -->
    <div class="modal fade" id="schedulePreviewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-calendar-alt me-2"></i>กำหนดการแข่งขัน</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="scheduleContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('scheduleContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Player List Modal -->
    <div class="modal fade" id="playerListModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white py-2">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i>ใบรายชื่อนักกีฬา</h5>
                    <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-secondary p-2" style="overflow-y: auto; max-height: 80vh;">
                    <div id="playerListContent" class="report-preview-page"></div>
                </div>
                <div class="modal-footer py-2">
                    <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">ปิด</button>
                    <button class="btn btn-primary btn-sm" onclick="printDocument('playerListContent')"><i class="fas fa-print me-1"></i> พิมพ์</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>ตั้งค่าระบบ</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    
                    <!-- ส่วนจัดการข้อมูล -->
                    <div class="setting-section">
                        <h6><i class="fas fa-database me-2"></i>จัดการข้อมูล</h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="data-mgmt-btn export-btn" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel d-block"></i>
                                    <strong>ส่งออก Excel</strong>
                                    <small class="d-block mt-1">บันทึกข้อมูลทั้งหมด</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="data-mgmt-btn import-btn" onclick="triggerImportExcel()">
                                    <i class="fas fa-file-import d-block"></i>
                                    <strong>นำเข้า Excel</strong>
                                    <small class="d-block mt-1">โหลดข้อมูลจากไฟล์</small>
                                </div>
                                <input type="file" id="importExcelInput" accept=".xlsx,.xls" style="display:none;" onchange="importFromExcel(event)">
                            </div>
                            <div class="col-md-4">
                                <div class="data-mgmt-btn reset-btn" onclick="resetAllData()">
                                    <i class="fas fa-trash-alt d-block"></i>
                                    <strong>ล้างข้อมูล</strong>
                                    <small class="d-block mt-1">Reset สำหรับปีใหม่</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning small mt-3 mb-0">
                            <i class="fas fa-exclamation-triangle me-1"></i> <strong>คำเตือน:</strong> การล้างข้อมูลจะลบรายการแข่งขันทั้งหมด แต่จะเก็บการตั้งค่าระบบไว้
                        </div>
                    </div>
                    
                    <div class="setting-section">
                        <h6><i class="fas fa-school me-2"></i>ข้อมูลพื้นฐาน</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ชื่อโรงเรียน</label>
                                <input type="text" class="form-control" id="settingSchoolName" placeholder="เช่น โรงเรียนกระดุมทองวิทยา">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ปีการศึกษา</label>
                                <input type="text" class="form-control" id="settingAcademicYear" placeholder="เช่น 2568">
                            </div>
                            <div class="col-12">
                                <label class="form-label small fw-bold">ชื่อกิจกรรม/งาน</label>
                                <input type="text" class="form-control" id="settingEventName" placeholder="เช่น กีฬาสี">
                            </div>
                        </div>
                    </div>

                    <!-- ส่วนจัดการทีม (ใหม่) -->
                    <div class="setting-section">
                        <h6><i class="fas fa-users me-2"></i>จัดการทีม</h6>
                        <div id="teamManagementContainer">
                            <!-- Will be populated dynamically -->
                        </div>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="addNewTeam()">
                            <i class="fas fa-plus me-1"></i> เพิ่มทีมใหม่
                        </button>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-image me-2"></i>รูปภาพ/โลโก้</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ตราโรงเรียน (.png)</label>
                                <input type="file" class="form-control form-control-sm" id="settingSchoolLogo" accept="image/png" onchange="previewLogo('school')">
                                <div class="mt-2 text-center">
                                    <img id="previewSchoolLogo" src="https://nonthaphathr.github.io/uploadimg/logoschool.png" class="logo-preview">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">ตรากิจกรรม (.png)</label>
                                <input type="file" class="form-control form-control-sm" id="settingEventLogo" accept="image/png" onchange="previewLogo('event')">
                                <div class="mt-2 text-center">
                                    <img id="previewEventLogo" src="" class="logo-preview" style="display:none;">
                                    <small id="noEventLogoText" class="text-muted">ยังไม่มีรูป</small>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-warning small mt-3 mb-0">
                            <i class="fas fa-info-circle"></i> <strong>หมายเหตุ:</strong> รูปภาพจะถูกแปลงเป็น Base64 และบันทึกลง Firebase
                        </div>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-running me-2"></i>รายการกีฬาที่จะจัด</h6>
                        <div class="mb-3">
                            <div class="input-group">
                                <input type="text" class="form-control" id="newSportKey" placeholder="รหัส (ภาษาอังกฤษ) เช่น football">
                                <input type="text" class="form-control" id="newSportName" placeholder="ชื่อกีฬา เช่น ฟุตบอล 7 คน">
                                <button class="btn btn-success" type="button" onclick="addSportToList()"><i class="fas fa-plus"></i></button>
                            </div>
                            <small class="text-muted">รหัสกีฬา: ใช้ภาษาอังกฤษ ไม่มีเว้นวรรค</small>
                        </div>
                        <div id="sportListContainer" class="border rounded p-2 bg-white" style="max-height: 200px; overflow-y: auto;">
                            <p class="text-center text-muted small mb-0">กำลังโหลดรายการกีฬา...</p>
                        </div>
                    </div>

                    <div class="setting-section">
                        <h6><i class="fas fa-lock me-2"></i>รหัสผ่านระบบ</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label small fw-bold">รหัสผ่านกรรมการ (ปลดล็อก/ลบ)</label>
                                <input type="text" class="form-control" id="settingPassword" placeholder="รหัสผ่าน">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                    <button type="button" class="btn btn-success" onclick="saveSettings()"><i class="fas fa-save me-1"></i> บันทึกการตั้งค่า</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Management Modal (ใหม่) -->
    <div class="modal fade" id="teamManagementModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>แก้ไขข้อมูลทีม</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editTeamKey">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ชื่อทีม</label>
                        <input type="text" class="form-control" id="editTeamName" placeholder="เช่น สีแดง, คณะเหนือ">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">สีประจำทีม</label>
                        <input type="color" class="form-control form-control-color" id="editTeamColor" value="#ffc107">
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="editTeamActive" checked>
                        <label class="form-check-label" for="editTeamActive">เปิดใช้งานทีมนี้</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" onclick="saveTeamEdit()">
                        <i class="fas fa-save me-1"></i> บันทึก
                    </button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, update, remove, set, get } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBc8zSVlgKarSt42YGFgSxHmqG7Max-3U0",
            authDomain: "keelaseesystem.firebaseapp.com",
            databaseURL: "https://keelaseesystem-default-rtdb.firebaseio.com",
            projectId: "keelaseesystem",
            storageBucket: "keelaseesystem.firebasestorage.app",
            messagingSenderId: "434885983982",
            appId: "1:434885983982:web:ffb751f1652abf2308fdff"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let currentMatchId = null;
        let matchDataLocal = {};
        let allMatchesData = {};
        let allMatchesArray = [];
        let editingMatchId = null;
        let isMatchUnlocked = false;

        // ===== ข้อมูลการตั้งค่าระบบ (รองรับ Dynamic Teams) =====
        let systemSettings = {
            schoolName: 'โรงเรียนกระดุมทองวิทยา',
            eventName: 'กีฬาสี',
            academicYear: '2568',
            schoolLogo: 'https://nonthaphathr.github.io/uploadimg/logoschool.png',
            eventLogo: '',
            password: 'KTW1234',
            teams: {
                'team1': { name: 'สีเหลือง', color: '#ffc107', active: true },
                'team2': { name: 'สีฟ้า', color: '#2196f3', active: true }
            },
            sports: {
                'football': 'ฟุตบอล 7 คน',
                'volleyball': 'วอลเลย์บอล',
                'beach_volleyball': 'วอลเลย์บอลชายหาด',
                'sepaktakraw': 'เซปักตะกร้อ',
                'esports': 'E-Sports ROV',
                'petanque': 'เปตอง',
                'athletics': 'กรีฑา',
                'folksport': 'กีฬาพื้นบ้าน',
                'cheer': 'ประกวดกองเชียร์ฯ'
            }
        };

        // ===== Helper Functions สำหรับ Teams =====
        window.getActiveTeams = () => {
            return Object.entries(systemSettings.teams || {})
                .filter(([key, team]) => team.active)
                .map(([key, team]) => ({ key, ...team }));
        };

        window.getTeamByKey = (key) => {
            return systemSettings.teams?.[key] || { name: key, color: '#999', active: false };
        };
    // ===== ฟังก์ชันแสดง/ซ่อนหน้า (แก้ไขให้ทำงานถูกต้อง) =====
        window.showPage = (pageId) => {
            // ซ่อนทุกหน้า
            document.querySelectorAll('.page-section').forEach(el => {
                el.classList.remove('active');
            });
            
            // แสดงหน้าที่ต้องการ
            const targetPage = document.getElementById('page-' + pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            // รีเซ็ต editingMatchId เมื่อกลับ dashboard
            if (pageId === 'dashboard') {
                renderMatchList();
                editingMatchId = null;
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // ===== โหลดการตั้งค่าจาก Firebase =====
        function loadSettings() {
            onValue(ref(db, 'settings'), (snap) => {
                const data = snap.val();
                if (data) {
                    systemSettings = { ...systemSettings, ...data };
                    if (data.sports) systemSettings.sports = data.sports;
                    if (data.teams) systemSettings.teams = data.teams;
                }
                applySettingsToUI();
                updateSportDropdown();
                updateScheduleDropdowns();
                renderTeamSummaryCards();
                renderTeamManagement();
            }, { onlyOnce: true });
        }

        // ===== ใช้การตั้งค่ากับ UI =====
        function applySettingsToUI() {
            document.getElementById('navbarLogo').src = systemSettings.schoolLogo;
            document.getElementById('navbarEventName').innerText = `${systemSettings.eventName} ${systemSettings.academicYear}`;
            document.getElementById('navbarSchoolName').innerText = systemSettings.schoolName;
            document.getElementById('loadingLogo').src = systemSettings.schoolLogo;
            document.getElementById('loadingEventName').innerText = `${systemSettings.eventName} ${systemSettings.academicYear}`;
            document.title = `ระบบบันทึกผลการแข่งขัน - ${systemSettings.eventName} ${systemSettings.academicYear}`;
            
            // อัพเดท Filter Winner Options
            const filterWinner = document.getElementById('filterWinner');
            const activeTeams = getActiveTeams();
            filterWinner.innerHTML = '<option value="all">ทั้งหมด</option>';
            activeTeams.forEach(team => {
                filterWinner.innerHTML += `<option value="${team.key}">${team.name}ชนะ</option>`;
            });
        }

        // ===== แสดงการ์ดสรุปคะแนนทีม (Dynamic) =====
        function renderTeamSummaryCards() {
            const container = document.getElementById('teamSummaryCards');
            const activeTeams = getActiveTeams();
            
            if (activeTeams.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-warning">กรุณาตั้งค่าทีมในระบบก่อนใช้งาน</div></div>';
                return;
            }
            
            container.innerHTML = '';
            activeTeams.forEach(team => {
                let wins = 0;
                allMatchesArray.forEach(m => {
                    if (m.status === 'done' && m.winner === team.key) wins++;
                });
                
                const colSize = Math.floor(12 / activeTeams.length);
                container.innerHTML += `
                    <div class="col-${colSize}">
                        <div class="glass-card p-2 p-md-3 d-flex justify-content-between align-items-center border-2" 
                             style="border-left: 5px solid ${team.color};">
                            <div>
                                <h4 class="mb-0 fw-bold text-dark" style="font-size: clamp(0.9rem, 3vw, 1.5rem);">
                                    <i class="fas fa-medal me-1 me-md-2" style="color: ${team.color};"></i>
                                    <span>${team.name}</span>
                                </h4>
                            </div>
                            <div class="text-end">
                                <span class="display-5 fw-bold" id="sumWin_${team.key}">${wins}</span> 
                                <small class="d-none d-sm-inline">เหรียญทอง</small>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // ===== อัพเดท Dropdown กีฬา =====
        function updateSportDropdown() {
            const select = document.getElementById('sportType');
            select.innerHTML = '<option value="" disabled selected>-- เลือก --</option>';
            Object.entries(systemSettings.sports).forEach(([key, name]) => {
                select.innerHTML += `<option value="${key}">${name}</option>`;
            });
        }

        // ===== อัพเดท Dropdown สำหรับกำหนดการ PDF =====
        function updateScheduleDropdowns() {
            const sportSelect = document.getElementById('scheduleSportSelect');
            if (sportSelect) {
                sportSelect.innerHTML = '<option value="all">ทุกกีฬา</option>';
                Object.entries(systemSettings.sports).forEach(([key, name]) => {
                    sportSelect.innerHTML += `<option value="${key}">${name}</option>`;
                });
            }
            
            const dateSelect = document.getElementById('scheduleDateSelect');
            if (dateSelect && allMatchesArray.length > 0) {
                dateSelect.innerHTML = '<option value="all">ทุกวัน (รวมทั้งหมด)</option>';
                const dates = [...new Set(allMatchesArray.map(m => m.date))].sort();
                dates.forEach(d => {
                    dateSelect.innerHTML += `<option value="${d}">${formatDateThai(d)}</option>`;
                });
            }
        }

        // ===== Render Team Selection (ใหม่) =====
        function renderTeamSelection() {
            const container = document.getElementById('teamSelectionContainer');
            const activeTeams = getActiveTeams();
            
            if (activeTeams.length < 2) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-danger small">ต้องมีอย่างน้อย 2 ทีมที่เปิดใช้งาน กรุณาตั้งค่าในเมนู "ตั้งค่าระบบ"</div></div>';
                return;
            }
            
            container.innerHTML = '';
            activeTeams.forEach(team => {
                container.innerHTML += `
                    <div class="col-6 col-md-4 col-lg-3">
                        <div class="team-select-card">
                            <input class="form-check-input team-checkbox" type="checkbox" 
                                   value="${team.key}" id="team_${team.key}" checked>
                            <label class="form-check-label w-100" for="team_${team.key}">
                                <div class="team-color-box" style="background: ${team.color};"></div>
                                <div class="team-name">${team.name}</div>
                            </label>
                        </div>
                    </div>
                `;
            });
        }

        // ===== แสดง Modal ตั้งค่า =====
        window.showSettings = async () => {
            const { value: pass } = await Swal.fire({
                title: 'ใส่รหัสผ่านเพื่อตั้งค่าระบบ',
                input: 'password',
                inputPlaceholder: 'รหัสผ่าน...',
                showCancelButton: true,
                confirmButtonText: 'เข้าสู่ระบบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (pass === systemSettings.password) {
                document.getElementById('settingSchoolName').value = systemSettings.schoolName;
                document.getElementById('settingEventName').value = systemSettings.eventName;
                document.getElementById('settingAcademicYear').value = systemSettings.academicYear;
                document.getElementById('settingPassword').value = systemSettings.password;
                document.getElementById('previewSchoolLogo').src = systemSettings.schoolLogo;
                
                if (systemSettings.eventLogo) {
                    document.getElementById('previewEventLogo').src = systemSettings.eventLogo;
                    document.getElementById('previewEventLogo').style.display = 'block';
                    document.getElementById('noEventLogoText').style.display = 'none';
                } else {
                    document.getElementById('previewEventLogo').style.display = 'none';
                    document.getElementById('noEventLogoText').style.display = 'block';
                }
                
                renderSportList();
                renderTeamManagement();
                new bootstrap.Modal(document.getElementById('settingsModal')).show();
            } else if (pass) {
                Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง' });
            }
        };

        // ===== Render Team Management (ใหม่) =====
        function renderTeamManagement() {
            const container = document.getElementById('teamManagementContainer');
            const teams = systemSettings.teams || {};
            
            if (Object.keys(teams).length === 0) {
                container.innerHTML = '<p class="text-muted small text-center">ยังไม่มีทีม กดปุ่ม "เพิ่มทีมใหม่" เพื่อสร้างทีม</p>';
                return;
            }
            
            let html = '';
            Object.entries(teams).forEach(([key, team]) => {
                const statusBadge = team.active 
                    ? '<span class="badge bg-success">ใช้งาน</span>' 
                    : '<span class="badge bg-secondary">ปิดใช้งาน</span>';
                
                html += `
                    <div class="d-flex align-items-center justify-content-between p-2 mb-2 border rounded bg-white">
                        <div class="d-flex align-items-center gap-2">
                            <div style="width: 30px; height: 30px; background: ${team.color}; border-radius: 5px;"></div>
                            <div>
                                <strong>${team.name}</strong>
                                <div class="small text-muted">${key}</div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            ${statusBadge}
                            <button class="btn btn-sm btn-outline-primary" onclick="editTeam('${key}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteTeam('${key}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ===== เพิ่มทีมใหม่ =====
        window.addNewTeam = async () => {
            const { value: teamName } = await Swal.fire({
                title: 'เพิ่มทีมใหม่',
                input: 'text',
                inputLabel: 'ชื่อทีม',
                inputPlaceholder: 'เช่น สีแดง, คณะเหนือ',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) return 'กรุณากรอกชื่อทีม';
                }
            });
            
            if (teamName) {
                const teamKey = 'team' + (Object.keys(systemSettings.teams).length + 1);
                const colors = ['#f44336', '#4caf50', '#ff9800', '#9c27b0', '#00bcd4', '#ffeb3b'];
                const randomColor = colors[Math.floor(Math.random() * colors.length)];
                
                systemSettings.teams[teamKey] = {
                    name: teamName,
                    color: randomColor,
                    active: true
                };
                
                renderTeamManagement();
            }
        };

        // ===== แก้ไขทีม =====
        window.editTeam = (key) => {
            const team = systemSettings.teams[key];
            document.getElementById('editTeamKey').value = key;
            document.getElementById('editTeamName').value = team.name;
            document.getElementById('editTeamColor').value = team.color;
            document.getElementById('editTeamActive').checked = team.active;
            
            new bootstrap.Modal(document.getElementById('teamManagementModal')).show();
        };

        // ===== บันทึกการแก้ไขทีม =====
        window.saveTeamEdit = () => {
            const key = document.getElementById('editTeamKey').value;
            const name = document.getElementById('editTeamName').value;
            const color = document.getElementById('editTeamColor').value;
            const active = document.getElementById('editTeamActive').checked;
            
            if (!name) {
                Swal.fire({ icon: 'warning', title: 'กรุณากรอกชื่อทีม' });
                return;
            }
            
            systemSettings.teams[key] = { name, color, active };
            renderTeamManagement();
            bootstrap.Modal.getInstance(document.getElementById('teamManagementModal')).hide();
            
            Swal.fire({ icon: 'success', title: 'บันทึกเรียบร้อย', timer: 1000, showConfirmButton: false });
        };

        // ===== ลบทีม =====
        window.deleteTeam = async (key) => {
            const result = await Swal.fire({
                title: 'ยืนยันการลบทีม?',
                text: 'การลบทีมจะส่งผลต่อข้อมูลการแข่งขันที่มีอยู่',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก'
            });
            
            if (result.isConfirmed) {
                delete systemSettings.teams[key];
                renderTeamManagement();
                Swal.fire({ icon: 'success', title: 'ลบเรียบร้อย', timer: 1000, showConfirmButton: false });
            }
        };

        // ===== แสดงรายการกีฬา =====
        function renderSportList() {
            const container = document.getElementById('sportListContainer');
            if (Object.keys(systemSettings.sports).length === 0) {
                container.innerHTML = '<p class="text-center text-muted small mb-0">ยังไม่มีรายการกีฬา</p>';
                return;
            }
            let html = '';
            Object.entries(systemSettings.sports).forEach(([key, name]) => {
                html += `
                    <div class="sport-item">
                        <div>
                            <span class="fw-bold">${name}</span>
                            <small class="text-muted ms-2">(${key})</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeSportFromList('${key}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // ===== เพิ่มกีฬา =====
        window.addSportToList = () => {
            const key = document.getElementById('newSportKey').value.trim().toLowerCase().replace(/\s+/g, '_');
            const name = document.getElementById('newSportName').value.trim();
            
            if (!key || !name) {
                Swal.fire({ icon: 'warning', title: 'กรุณากรอกข้อมูลให้ครบ' });
                return;
            }
            
            if (systemSettings.sports[key]) {
                Swal.fire({ icon: 'warning', title: 'รหัสกีฬานี้มีอยู่แล้ว' });
                return;
            }
            
            systemSettings.sports[key] = name;
            renderSportList();
            document.getElementById('newSportKey').value = '';
            document.getElementById('newSportName').value = '';
        };

        // ===== ลบกีฬา =====
        window.removeSportFromList = (key) => {
            if (confirm(`ลบกีฬา "${systemSettings.sports[key]}" ?`)) {
                delete systemSettings.sports[key];
                renderSportList();
            }
        };

        // ===== Preview Logo =====
        window.previewLogo = (type) => {
            const input = document.getElementById(type === 'school' ? 'settingSchoolLogo' : 'settingEventLogo');
            const preview = document.getElementById(type === 'school' ? 'previewSchoolLogo' : 'previewEventLogo');
            const noText = document.getElementById('noEventLogoText');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    if (type === 'event' && noText) noText.style.display = 'none';
                };
                reader.readAsDataURL(input.files[0]);
            }
        };

        // ===== บันทึกการตั้งค่า =====
        window.saveSettings = async () => {
            systemSettings.schoolName = document.getElementById('settingSchoolName').value || systemSettings.schoolName;
            systemSettings.eventName = document.getElementById('settingEventName').value || systemSettings.eventName;
            systemSettings.academicYear = document.getElementById('settingAcademicYear').value || systemSettings.academicYear;
            systemSettings.password = document.getElementById('settingPassword').value || systemSettings.password;
            
            const schoolLogoInput = document.getElementById('settingSchoolLogo');
            const eventLogoInput = document.getElementById('settingEventLogo');
            
            if (schoolLogoInput.files && schoolLogoInput.files[0]) {
                systemSettings.schoolLogo = await fileToBase64(schoolLogoInput.files[0]);
            }
            
            if (eventLogoInput.files && eventLogoInput.files[0]) {
                systemSettings.eventLogo = await fileToBase64(eventLogoInput.files[0]);
            }
            
            set(ref(db, 'settings'), systemSettings).then(() => {
                applySettingsToUI();
                updateSportDropdown();
                updateScheduleDropdowns();
                renderTeamSummaryCards();
                Swal.fire({ icon: 'success', title: 'บันทึกการตั้งค่าเรียบร้อย', timer: 1500, showConfirmButton: false });
                bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            }).catch((error) => {
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
            });
        };

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // ===== Toggle Set Count =====
        window.toggleSetCount = () => {
            const method = document.getElementById('scoringMethod').value;
            const container = document.getElementById('setCountContainer');
            if (method === 'score_set' || method === 'win_set') {
                container.classList.remove('d-none');
            } else {
                container.classList.add('d-none');
            }
        };

        // ===== ฟังก์ชันแปลงวันที่ =====
        window.getThaiDate = () => {
            const date = new Date();
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const day = date.getDate();
            const month = months[date.getMonth()];
            const year = date.getFullYear() + 543;
            return `${day} ${month} ${year}`;
        };
        
        function formatDateThai(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()+543}`;
        }

        function formatDateThaiLong(dateStr) {
            if(!dateStr) return '';
            const d = new Date(dateStr);
            const months = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()+543}`;
        }

        function getScoringMethodName(method) {
            const methods = {
                'score_set': 'ลงคะแนน Set',
                'win_set': 'ชนะ/แพ้ Set',
                'score_once': 'ลงคะแนนรอบเดียว',
                'win_once': 'ชนะ/แพ้รอบเดียว'
            };
            return methods[method] || method;
        }
        
        // ===== พิมพ์เอกสาร =====
        window.printDocument = (elementId) => {
            const element = document.getElementById(elementId);
            const printWindow = window.open('', '', 'width=900,height=700');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>พิมพ์เอกสาร - ${systemSettings.eventName} ${systemSettings.academicYear}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
                    <style>
                        @page { size: A4; margin: 20mm 25mm; }
                        body { font-family: 'Kanit', sans-serif; margin: 0; padding: 0; background: white; line-height: 1.5; }
                        @media print { body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } }
                        .speech-line { text-align: justify; text-justify: inter-word; margin-bottom: 8px; line-height: 1.6; }
                        .speech-indent { text-indent: 2.5cm; }
                        table { border-collapse: collapse; }
                    </style>
                </head>
                <body>${element.innerHTML}</body>
                </html>
            `);
            
            printWindow.document.close();
            setTimeout(() => { printWindow.focus(); printWindow.print(); printWindow.close(); }, 500);
        };

        window.forceHideLoader = () => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => { overlay.style.display = 'none'; }, 300);
            }
        };

        window.getSportName = (k) => systemSettings.sports[k] || k;

        window.showManual = () => {
            Swal.fire({
                title: 'คู่มือการใช้งาน',
                html: `<ul class="text-start small">
                    <li><b>เพิ่มรายการ:</b> สร้างรายการแข่งใหม่ (เลือกทีมที่เข้าแข่งได้)</li>
                    <li><b>แก้ไขรายการ:</b> กดปุ่มสีฟ้า > แก้ไขรายละเอียด</li>
                    <li><b>ลงทะเบียน:</b> แท็บ "รายชื่อ" กด + เพิ่มนักกีฬา</li>
                    <li><b>ลงคะแนน:</b> กดปุ่มปลดล็อก > ใส่รหัส</li>
                    <li><b>ตั้งค่าระบบ:</b> ปรับชื่อโรงเรียน/กิจกรรม/กีฬา/ทีม</li>
                    <li><b>จัดการทีม:</b> เพิ่ม/แก้ไข/ลบทีม เปิด/ปิดใช้งานทีม</li>
                    <li><b>ส่งออก Excel:</b> บันทึกข้อมูลทั้งหมดเป็นไฟล์ Excel</li>
                    <li><b>นำเข้า Excel:</b> โหลดข้อมูลจากไฟล์ที่ส่งออก</li>
                    <li><b>ล้างข้อมูล:</b> Reset สำหรับปีการศึกษาใหม่</li>
                </ul>`,
                confirmButtonText: 'เข้าใจแล้ว'
            });
        };

        // ===== QR Code =====
        window.showQRCode = () => {
            const currentUrl = window.location.href;
            const path = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            const registerUrl = `${path}/register.html`;

            const html = `
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <div class="p-3 border rounded bg-light h-100">
                            <h6 class="fw-bold text-primary mb-2">1. ระบบจัดการ (สำหรับครู/กรรมการ)</h6>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(currentUrl)}" class="img-fluid mb-2 border bg-white p-1">
                            <p class="small text-muted mb-0">ใช้บันทึกผลและจัดการการแข่งขัน</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="p-3 border rounded bg-white h-100 shadow-sm border-warning">
                            <h6 class="fw-bold text-warning-emphasis mb-2">2. จุดลงทะเบียนนักกีฬา</h6>
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(registerUrl)}" class="img-fluid mb-2 border bg-white p-1">
                            <p class="small text-muted mb-2">ให้นักเรียนสแกนเพื่อกรอกชื่อ</p>
                            <a href="${registerUrl}" target="_blank" class="btn btn-sm btn-outline-dark w-100">เปิดหน้าลงทะเบียน</a>
                        </div>
                    </div>
                </div>
            `;

            const modalDialog = document.querySelector('#qrModal .modal-dialog');
            modalDialog.classList.remove('modal-sm');
            modalDialog.classList.add('modal-lg');
            
            document.querySelector('#qrModal .modal-body').innerHTML = html;
            new bootstrap.Modal(document.getElementById('qrModal')).show();
        };

        // ===== โหลดรายการแข่งขัน =====
        function loadMatches() {
            onValue(ref(db, 'matches'), (snap) => {
                forceHideLoader();
                const data = snap.val();
                allMatchesData = data || {};
                if(data) {
                    allMatchesArray = Object.keys(data).map(k => ({...data[k], id: k}));
                    allMatchesArray.sort((a,b) => (a.date + a.time).localeCompare(b.date + b.time));
                } else {
                    allMatchesArray = [];
                }
                updateFilterOptions();
                updateScheduleDropdowns();
                renderMatchList();
                renderTeamSummaryCards();
            }, (error) => {
                forceHideLoader();
                Swal.fire('Error', 'เชื่อมต่อ Firebase ไม่ได้', 'error');
            });
        }

        function updateFilterOptions() {
            const filterSportSel = document.getElementById('filterSport');
            const currentSport = filterSportSel.value;
            filterSportSel.innerHTML = '<option value="all">ทุกกีฬา</option>';
            const sports = [...new Set(allMatchesArray.map(m => m.sport))];
            sports.forEach(s => { filterSportSel.innerHTML += `<option value="${s}">${getSportName(s)}</option>`; });
            if([...filterSportSel.options].some(o => o.value === currentSport)) filterSportSel.value = currentSport;

            const filterDateSel = document.getElementById('filterDate');
            const currentDate = filterDateSel.value;
            filterDateSel.innerHTML = '<option value="all">ทุกวัน</option>';
            const dates = [...new Set(allMatchesArray.map(m => m.date))].sort();
            dates.forEach(d => { filterDateSel.innerHTML += `<option value="${d}">${formatDateThai(d)}</option>`; });
            if([...filterDateSel.options].some(o => o.value === currentDate)) filterDateSel.value = currentDate;
        }

        // ===== แสดงรายการแข่งขัน =====
        window.renderMatchList = () => {
            const filterS = document.getElementById('filterSport').value;
            const filterW = document.getElementById('filterWinner').value;
            const filterD = document.getElementById('filterDate').value;
            const filterM = document.getElementById('filterScoringMethod').value;
            const list = document.getElementById('matchList');
            list.innerHTML = '';
            
            if(allMatchesArray.length === 0) {
                list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ไม่พบข้อมูล<br><small>กดปุ่ม "เพิ่มรายการ" เพื่อสร้างใหม่</small></td></tr>';
                renderTeamSummaryCards();
                return;
            }

            let displayCount = 0;
            allMatchesArray.forEach(m => {
                if(filterS !== 'all' && m.sport !== filterS) return;
                if(filterW !== 'all' && m.winner !== filterW) return;
                if(filterD !== 'all' && m.date !== filterD) return;
                if(filterM !== 'all' && (m.scoringMethod || 'score_once') !== filterM) return;

                displayCount++;
                
                const matchTeams = m.teams || ['team1', 'team2'];
                const scores = matchTeams.map(tk => {
                    const team = getTeamByKey(tk);
                    const score = m.scores?.[tk] || 0;
                    return { key: tk, name: team.name, color: team.color, score };
                });
                
                const scoreDisplay = scores.map(s => `${s.score}`).join(' - ');
                
                let winnerDisplay = '-';
                if (m.status === 'done' && m.winner) {
                    const winTeam = getTeamByKey(m.winner);
                    winnerDisplay = `<span class="fw-bold" style="color: ${winTeam.color};">●</span>`;
                }
                
                let badge = m.status === 'done' ? '<span class="status-badge bg-done">จบ</span>' : '<span class="status-badge bg-wait">รอ</span>';
                const hasRefs = m.referees && m.referees.some(r => r.trim() !== '');
                const refIcon = hasRefs ? '<i class="fas fa-whistle text-success me-1"></i>' : '<i class="fas fa-whistle text-secondary opacity-25 me-1"></i>';
                
                let hasPlayers = false;
                if (m.players) {
                    Object.values(m.players).forEach(pArr => {
                        if (pArr && pArr.some(p => p.trim() !== '')) hasPlayers = true;
                    });
                }
                const playerIcon = hasPlayers ? '<i class="fas fa-users text-success"></i>' : '<i class="fas fa-users text-secondary opacity-25"></i>';

                list.innerHTML += `
                    <tr>
                        <td>${m.time || '-'}<br>${badge}</td>
                        <td>
                            <strong style="font-size: 0.9em;">${getSportName(m.sport)}</strong>
                            <br><small class="text-muted">${m.category || '-'}</small>
                            <div class="mt-1 small">${refIcon} ${playerIcon}</div>
                        </td>
                        <td class="text-center"><span class="badge bg-light text-dark border">${scoreDisplay}</span></td>
                        <td class="text-center">${winnerDisplay}</td>
                        <td class="text-end">
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown"><i class="fas fa-copy"></i></button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="copyMatchText('${m.id}', 'schedule')">คัดลอกกำหนดการ</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="copyMatchText('${m.id}', 'result')">คัดลอกผลการแข่งขัน</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="editMatchDetails('${m.id}')">แก้ไขรายละเอียด</a></li>
                                </ul>
                                <button class="btn btn-outline-dark" onclick="openMatch('${m.id}')"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-outline-danger" onclick="deleteMatch('${m.id}')"><i class="fas fa-trash"></i></button>
                                ${m.status === 'done' ? `<button class="btn btn-danger" onclick="previewReport('${m.id}')"><i class="fas fa-print"></i></button>` : ''}
                            </div>
                        </td>
                    </tr>`;
            });
            
            if(displayCount === 0) list.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">ไม่พบรายการที่ตรงกับตัวกรอง</td></tr>';
            renderTeamSummaryCards();
        };

        window.applyFilters = () => { renderMatchList(); };

        // ===== เพิ่ม/แก้ไขรายการแข่งขัน (รองรับ Dynamic Teams) =====
        window.prepareAddMatch = () => {
            editingMatchId = null;
            document.getElementById('setupForm').reset();
            document.getElementById('setupTitle').innerHTML = '<i class="fas fa-calendar-plus"></i> เพิ่มรายการแข่งขัน';
            document.getElementById('setupSubmitBtn').innerText = 'บันทึก';
            document.getElementById('matchDate').value = new Date().toISOString().slice(0,10);
            document.getElementById('setCountContainer').classList.add('d-none');
            updateSportDropdown();
            renderTeamSelection();
            showPage('setup');
        };

        window.editMatchDetails = (id) => {
            const m = allMatchesArray.find(x => x.id === id);
            if(!m) return;
            editingMatchId = id;
            updateSportDropdown();
            document.getElementById('sportType').value = m.sport;
            document.getElementById('category').value = m.category;
            document.getElementById('matchDate').value = m.date;
            document.getElementById('matchTime').value = m.time;
            document.getElementById('location').value = m.location || '';
            document.getElementById('scoringMethod').value = m.scoringMethod || 'score_once';
            toggleSetCount();
            if (m.setCount) document.getElementById('setCount').value = m.setCount;
            
            renderTeamSelection();
            
            // เลือกทีมที่ใช้ในการแข่งขันนี้
            if (m.teams && m.teams.length > 0) {
                document.querySelectorAll('.team-checkbox').forEach(cb => {
                    cb.checked = m.teams.includes(cb.value);
                });
            }
            
            document.getElementById('setupTitle').innerHTML = '<i class="fas fa-edit"></i> แก้ไขรายละเอียด';
            document.getElementById('setupSubmitBtn').innerText = 'บันทึกการแก้ไข';
            showPage('setup');
        };

        document.getElementById('setupForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const sport = document.getElementById('sportType').value;
            const category = document.getElementById('category').value;
            const matchDate = document.getElementById('matchDate').value;
            const matchTime = document.getElementById('matchTime').value;
            const location = document.getElementById('location').value;
            const scoringMethod = document.getElementById('scoringMethod').value;
            const setCount = parseInt(document.getElementById('setCount').value) || 3;
            
            // รับทีมที่เลือก
            const selectedTeams = [];
            document.querySelectorAll('.team-checkbox:checked').forEach(cb => {
                selectedTeams.push(cb.value);
            });
            
            if (selectedTeams.length < 2) {
                Swal.fire({ icon: 'warning', title: 'กรุณาเลือกอย่างน้อย 2 ทีม' });
                return;
            }
            
            if(!sport || !category || !matchDate || !matchTime || !scoringMethod) { 
                Swal.fire('กรุณากรอกข้อมูลให้ครบ', '', 'warning'); 
                return; 
            }
            
            if(editingMatchId) {
                const updateData = { 
                    sport, category, date: matchDate, time: matchTime, location: location || '', 
                    scoringMethod, teams: selectedTeams 
                };
                if (scoringMethod === 'score_set' || scoringMethod === 'win_set') updateData.setCount = setCount;
                
                update(ref(db, `matches/${editingMatchId}`), updateData).then(() => {
                    Swal.fire({ icon: 'success', title: 'บันทึกการแก้ไขเรียบร้อย', timer: 1500, showConfirmButton: false });
                    editingMatchId = null;
                    document.getElementById('setupForm').reset();
                    showPage('dashboard');
                }).catch((error) => { Swal.fire('Error', 'ไม่สามารถแก้ไขได้', 'error'); });
            } else {
                let refs = sport === 'cheer' ? ['','','','',''] : ['']; 
                
                // สร้าง scores object และ players object
                const scores = {};
                const players = {};
                selectedTeams.forEach(tk => {
                    scores[tk] = 0;
                    players[tk] = [];
                });
                
                const newMatch = {
                    sport, category, date: matchDate, time: matchTime, location: location || '',
                    status: 'wait', 
                    scores: scores,
                    winner: 'none',
                    scoringMethod: scoringMethod,
                    details: {}, 
                    referees: refs, 
                    athleteSign: '', 
                    note: '', 
                    players: players,
                    teams: selectedTeams,
                    createdAt: new Date().toISOString()
                };
                if (scoringMethod === 'score_set' || scoringMethod === 'win_set') newMatch.setCount = setCount;
                
                push(ref(db, 'matches'), newMatch).then(() => {
                    Swal.fire({ icon: 'success', title: 'เพิ่มรายการเรียบร้อย', timer: 1500, showConfirmButton: false });
                    document.getElementById('setupForm').reset();
                    document.getElementById('matchDate').value = new Date().toISOString().slice(0,10);
                    showPage('dashboard');
                }).catch((error) => { Swal.fire('Error', 'ไม่สามารถเพิ่มรายการได้', 'error'); });
            }
        });

        // ===== ลบรายการแข่งขัน =====
        window.deleteMatch = async (id) => {
            const { value: pass } = await Swal.fire({
                title: 'ยืนยันการลบรายการ?',
                text: 'การกระทำนี้ไม่สามารถกู้คืนได้ กรุณาใส่รหัสผ่านเพื่อยืนยัน',
                input: 'password',
                inputPlaceholder: 'รหัสผ่าน...',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'ลบรายการ',
                cancelButtonText: 'ยกเลิก'
            });
            if (pass === systemSettings.password) {
                remove(ref(db, 'matches/'+id)).then(() => { 
                    Swal.fire({ icon: 'success', title: 'ลบเรียบร้อย', timer: 1000, showConfirmButton: false }); 
                });
            } else if (pass) { 
                Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง' }); 
            }
        };

        // ===== Initialization =====
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(forceHideLoader, 5000);
            loadSettings();
            loadMatches();
        });
        
        loadSettings();
        loadMatches();
    </script>
</body>
</html>
